!function(){ht.confirm={init:function(){ht.core.dialog.init(),ht.core.popUp.init(),ht.core.location.init(),this.bindEvent()},setOnlyAddress:function(e){$("#onlyAddress").empty(),$("#templateOnlyAddress").tmpl(e).appendTo("#onlyAddress"),$("#address_id").val(e.id)},getThisAddress:function(){var e=this,s=$("#address_id").val(),d=1;if(e.dataAddress.length>0){for(var t=0,a=e.dataAddress.length;a>t;t++)if(e.dataAddress[t].id==s){var r=t,i=e.dataAddress[r];return e.setOnlyAddress(i),void(d=0)}if(1==d){var i=e.dataAddress[0];$("#newbtnbox")[0]?($("#newbtnbox").remove(),$("#g-bd").prepend('<section class="m-recaddr" id="onlyAddress"></section><input type="hidden" id="address_id" name="address_id" value="'+i.id+'"/>'),e.setOnlyAddress(i)):e.setOnlyAddress(i)}}else $("#onlyAddress,#address_id").remove(),$("#g-bd").prepend("<section id=newbtnbox class=m-newbtnbox><span id=w-newbtn class=w-newbtn><span class=u-icn14></span>新建收货地址</span></section>")},goBack:function(){var e=this,s=$("#toptitle"),d=s.html();switch(d){case"确认订单":history.back();break;case"收货地址选择":s.html("确认订单"),$("#address").addClass("f-dn"),$("#orderform").removeClass("f-dn"),e.getThisAddress();break;case"修改收货地址":s.html("收货地址选择"),$("#addressList").show(),$("#newaddressbox").empty();break;case"新建收货地址":e.dataAddress?(s.html("收货地址选择"),$("#newaddressbox").empty(),$("#addressList").show()):(s.html("确认订单"),$("#newaddressbox").empty().hide(),$("#address").addClass("f-dn"),$("#orderform").removeClass("f-dn"))}},dataAddress:null,parseDataAddress:function(e){for(var s=0,d=e.length;d>s;s++)e[s].index=s,e[s].isChecked=0,e[s].addressInfo=e[s].province+e[s].city+e[s].area+e[s].address,$("#address_id")[0]&&$("#address_id").val()==e[s].id&&(e[s].isChecked=1);return e},getAddressList:function(){var e=this;$.getJSON("/member/address_list.html",function(s){200==s.state&&($("#myAddressList").empty(),e.dataAddress=s.addresses,e.dataAddress=e.parseDataAddress(e.dataAddress),$("#templateAddList").tmpl(e.dataAddress).appendTo("#myAddressList"),$("#address").removeClass("f-dn"),$("#orderform").addClass("f-dn"),$("#toptitle").html("收货地址选择"),$("#menu").hide())})},bindEvent:function(){var e=this,s=$("#toptitle");$("#backbtnConf").on("click",function(){e.goBack()}),$("#myAddressList").on("click",".choseAddress",function(){if(1==$(this)[0].checked){var d=$(this).attr("data-index"),t=e.dataAddress[d];e.setOnlyAddress(t),$("#address").addClass("f-dn"),s.html("确认订单"),$("#orderform").removeClass("f-dn")}$("#newbtnbox").remove()}),$("#g-bd").on("click","#w-newbtn",function(){$("#address").removeClass("f-dn"),$("#addressList").hide(),$("#newaddressbox").empty().show();var e;e="True"==$("#is_abroad").val()?"True":"False",$("#templateAddAddress").tmpl({isEdit:0,is_abroad:e}).appendTo("#newaddressbox"),$("#orderform").addClass("f-dn"),s.html("新建收货地址"),ht.core.location.getLocation(0)}),$(".submitbtn").on("click",function(){return $("#oneaddress")[0]?void $("#orderSubmitForm")[0].submit():(ht.core.popUp.show("请先填写收货地址"),!1)}),$("#newbtn").on("click",function(){$("#addressList").hide(),$("#newaddressbox").empty().show();var e;e="False",$("#templateAddAddress").tmpl({isEdit:0,is_abroad:e}).appendTo("#newaddressbox"),s.html("新建收货地址"),ht.core.location.getLocation(0)}),$("#myAddressList").on("click",".delete",function(){var s=$(this),d=s.closest(".addritm"),t=$("#myAddressList .addritm").index(d),a=[{_aniClass:"show",confirm:{text:"确定要删除该收货地址吗？",btns:[{text:"确定",action:"ok"},{text:"取消",action:"close"}]}}];ht.core.dialog.show(a),ht.core.dialog.yes(function(){var d={_xsrf:$("input[name=_xsrf]").val(),address_id:s.closest(".addritm").attr("data-id")};$.ajax({url:"/member/address.html",data:d,type:"DELETE",success:function(d){d=JSON.parse(d),200==d.state&&(s.closest(".addritm").remove(),e.dataAddress.splice(t,1),ht.core.dialog.hide())}})})}).on("click",".edit",function(){var d=$(this),t=d.closest(".addritm"),a=$("#myAddressList .addritm").index(t);$("#addressList").hide(),$("#newaddressbox").empty().show();var r=e.dataAddress[a];r.isEdit=1,r.is_abroad="False",$("#templateAddAddress").tmpl(r).appendTo("#newaddressbox"),ht.core.location.getLocation(1,function(){var e=$("#province .option[title="+r.province+"]");e.attr("selected","selected");var s=e.attr("value"),d={parent_id:s,query_type:"city"};ht.core.location.get(d,"zp-city",0,$("#city"),1,function(){var e=$("#city .option[title="+r.city+"]");e.attr("selected","selected");var s=e.attr("value"),d={parent_id:s,query_type:"area"};ht.core.location.get(d,"zp-area",0,$("#area"),1,function(){var e=$("#area .option[title="+r.area+"]");e.attr("selected","selected")})})}),s.html("修改收货地址")}),$("#g-bd").on("click","#onlyAddress",function(){e.getAddressList()}),$("body").on("click","#m-savebtn",function(){var d=$("#name"),t=$("#mobile"),a=$("#province"),r=$("#city"),i=$("#area"),o=$("#yourAddress");if(""==$.trim($("#name").val()))return void ht.core.popUp.show(d.attr("data-message"));if(!ht.core.regular.phone.test(t.val()))return void ht.core.popUp.show(t.attr("data-message"));if("-1"==a.val())return void ht.core.popUp.show(a.attr("data-message"));if("-1"==r.val())return void ht.core.popUp.show(r.attr("data-message"));if("-1"==i.val())return void ht.core.popUp.show(i.attr("data-message"));if(o.val().length<5)return void ht.core.popUp.show(o.attr("data-message"));var n={_xsrf:$("input[name=_xsrf]").val(),name:d.val(),province:a.val(),city:r.val(),area:i.val(),address:o.val(),card_num:"",phone:t.val()};1==$(this).attr("data-isEdit")&&(n.address_id=$(this).attr("data-id"));n.address_id;$.post("/member/address.html",n,function(d){var d=JSON.parse(d);200==d.state&&(s.html("收货地址选择"),e.getAddressList(),$("#newaddressbox").empty(),$("#addressList").show())})})}},$(function(){ht.confirm.init()})}();