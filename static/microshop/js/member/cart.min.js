!function(){ht.cart={init:function(){ht.core.dialog.init(),this.getEmptyTemp(),this.getData(),this.bindEvent()},getTaxByWarehouse:function(t){var e="True"==t?0:1,i=ht.core.ops.tax[e];return i},oriData:{},getEmptyTemp:function(){var t='<section class="m-emtpy f-tac"><span class="u-icn5"></span><p class="tiptxt">购物车里空空如也，赶紧去逛逛吧！</p><a class="u-btn" href="/">去逛逛</a></section>';$("#appfootmenu")[0]&&(t='<section class="m-emtpy f-tac"><span class="u-icn5"></span><p class="tiptxt">购物车里空空如也，赶紧去逛逛吧！</p><a class="u-btn" href="/app/index.html">去逛逛</a></section>'),$.template("templateEmpty",t)},parseData:function(t){t.price=0,t.good_counts=t.items.length,t.total_price=0,t.moneyCount=0,t.goods=t.items;for(var e=0,i=t.items.length;i>e;e++)t.total_price=t.total_price+t.items[e].price*t.items[e].amount,t.items[e].main_pic=t.items[e].main_pic.indexOf(";")>-1?t.items[e].main_pic.split(";")[0]:t.items[e].main_pic,t.items[e].pIndex=e;return t.moneyCount=t.total_price,t},getData:function(){var t=this;$("#carts").empty();var e={_xsrf:$("input[name=_xsrf]").val()};$.ajax({url:"/member/cart.html",data:e,type:"PUT",success:function(e){if(e=JSON.parse(e),200==e.state){var i=e.items;$("#cartCount").html("("+e.total_count+")"),i=t.parseData(e),t.oriData=i,0==i.total_count?$.tmpl("templateEmpty",{}).appendTo("#carts"):$("#templateOrder").tmpl(i).appendTo("#carts")}}})},changeProductNum:function(){var t={item_id:ht.detail.goodInfo.itemId,item_num:$("#tempBuyAmountObj").val()};$.getJSON("/member/addcart",t,function(t){if(200==t.state){var e=t.account;e=e>99?"99+":e,$("#cart .count").text(e)}$("#popUp").hide(),$("#topbar-back").click()})},getGoodObj:function(t){var e=parseInt(t.attr("data-pIndex"),10),i={orderO:this.oriData,goods:this.oriData.items[e],goodsO:this.oriData.items,pIndex:e};return i},getHouseObj:function(t){var e=parseInt(t.attr("data-oIndex"),10),i={orderO:this.oriData,ordersObj:this.oriData[e]};return i},changeCount:function(t,e){var i=this,s=t.closest(".gitm"),a=t.closest(".m-cart"),n=i.getGoodObj(s).goods,o={_xsrf:$("input[name=_xsrf]").val(),item_id:n.id,item_num:e};$.ajax({url:"/member/addcart",data:o,type:"PUT",success:function(t){t=JSON.parse(t),200==t.state&&(i.setChosenNum(a),i.getALLPrice(a),i.getCountNum())}})},getALLPrice:function(t){var e,i,s=this,a=0,n=0;t.find(".chosen").each(function(){e=s.getGoodObj($(this)),i=$(this).find(".buyNum").val(),a=parseFloat(a)+parseFloat(parseInt(i,10)*e.goods.price);e.goods.tax_rate;n=0}),a=a.toFixed(2),n=n.toFixed(2);var o=0;o=0,t.find(".tariffLbl").addClass("del"),t.find(".tariff").text(n),t.find(".total_price").text(a);var n=0,c=parseFloat(a)+o;t.find(".moneyCount").text(c);var r=parseFloat(t.find(".finalChooseNum").text());0==r?t.find(".settlementBtn").addClass("u-btn-disab"):t.find(".settlementBtn").removeClass("u-btn-disab")},setChosenNum:function(t){var e=0;t.find(".chosen .buyNum").each(function(){e+=parseInt($(this).val(),10)});var i=e;t.find(".finalChooseNum").text(i)},getCountNum:function(){var t=0;$(".buyNum").each(function(){t+=parseInt($(this).val(),10)}),$("#cartCount").html("("+t+")")},bindEvent:function(){var t=this;$("#carts").on("click",".checkAll",function(){var e=$(this).closest(".m-cart");1==$(this)[0].checked?e.find(".m-cartgoods").find("input[type=checkbox]").each(function(){$(this)[0].checked="checked";var t=$(this).closest(".gitm");t.addClass("chosen")}):e.find(".m-cartgoods").find("input[type=checkbox]").each(function(){$(this)[0].checked="",$(this).siblings("input[name=item_id]").remove();var t=$(this).closest(".gitm");t.removeClass("chosen")}),t.setChosenNum(e),t.getALLPrice(e)}).on("click",".checkone",function(){var e=$(this).closest(".m-cart"),i=$(this).closest(".gitm"),s=t.getGoodObj(i);if(1==$(this)[0].checked){if(!$(this).siblings("input[name=item_id]")[0]){var a=s.goods.id;$(this).before('<input type="hidden" name="item_id" value="'+a+'">')}i.addClass("chosen")}else i.removeClass("chosen"),$(this).siblings("input[name=item_id]").remove();t.setChosenNum(e),t.getALLPrice(e)});var e=[{_aniClass:"show",confirm:{text:"确定删除该商品吗？",btns:[{text:"确定",action:"ok"},{text:"取消",action:"close"}]}}];$("#carts").on("click",".u-remove",function(){var i=$(this),s=$(this).closest(".m-cart"),a=i.closest(".gitm");ht.core.dialog.show(e);var n=t.getGoodObj(a);$("body").on("click","#m-dialog .ok",function(){var e={_xsrf:$("input[name=_xsrf]").val(),item_id:n.goods.id};$.ajax({url:"/member/cart.html",data:e,type:"DELETE",success:function(e){e=JSON.parse(e),200==e.state&&($("#m-dialog").remove(),1==n.goodsO.length&&a.closest(".m-cart").remove(),a.remove(),0==$("#carts .m-cart").length?($.tmpl("templateEmpty",{}).appendTo("#carts"),$("#cartCount").html("(0)")):(t.setChosenNum(s),t.getALLPrice(s)),t.getCountNum())}})})}),$("#carts").on("click",".settlementBtn",function(){$(this).hasClass("u-btn-disab")||$(this).closest("form")[0].submit()});var i;$("#carts").on("click",".plus",function(){var e=$(this),s=$(this).closest(".gitm"),a=t.getGoodObj(s).goods,n=a.min_limit_quantity,o=a.max_limit_quantity,c=$(this).siblings(".buyNum"),r=c.val();if(r==o)return!1;c.val(parseInt(r,10)+1),c.val()>n&&$(this).siblings(".minus").removeClass("z-dis"),c.val()==o&&$(this).addClass("z-dis"),clearTimeout(i);var r=c.val();s.find(".goodAmount").text(r),i=setTimeout(function(){t.changeCount(e,r)},500)}).on("click",".minus",function(){var e=$(this),s=$(this).closest(".gitm"),a=t.getGoodObj(s).goods,n=a.min_limit_quantity,o=a.max_limit_quantity,c=$(this).siblings(".buyNum"),r=c.val();$(this).hasClass("z-dis")||(c.val(parseInt(r,10)-1),r=c.val(),r==n&&$(this).addClass("z-dis"),o>r&&$(this).siblings(".plus").removeClass("z-dis"),s.find(".goodAmount").text(r),clearTimeout(i),i=setTimeout(function(){t.changeCount(e,r)},500))})}},$(function(){ht.cart.init()})}();