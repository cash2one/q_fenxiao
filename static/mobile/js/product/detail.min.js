!function(t){t.fly=function(i,a){var o={version:"1.0.0",autoPlay:!0,vertex_Rtop:20,speed:1.2,start:{},end:{},onEnd:t.noop},s=this,e=t(i);s.init=function(t){this.setOptions(t),!!this.settings.autoPlay&&this.play()},s.setOptions=function(i){this.settings=t.extend(!0,{},o,i);var a=this.settings,s=a.start,n=a.end;e.css({marginTop:"0px",marginLeft:"0px",position:"absolute"}).appendTo("body"),null!=n.width&&null!=n.height&&t.extend(!0,s,{width:e.width(),height:e.height()});var d=Math.min(s.top,n.top)-Math.abs(s.left-n.left)/3;d<a.vertex_Rtop&&(d=Math.min(a.vertex_Rtop,Math.min(s.top,n.top)));var l=Math.sqrt(Math.pow(s.top-n.top,2)+Math.pow(s.left-n.left,2)),h=Math.ceil(Math.min(Math.max(Math.log(l)/.05-75,30),100)/a.speed),r=s.top==d?0:-Math.sqrt((n.top-d)/(s.top-d)),m=(r*s.left-n.left)/(r-1),u=n.left==m?0:(n.top-d)/Math.pow(n.left-m,2);t.extend(!0,a,{count:-1,steps:h,vertex_left:m,vertex_top:d,curvature:u})},s.play=function(){this.move()},s.move=function(){var i=this.settings,a=i.start,o=i.count,s=i.steps,n=i.end,d=a.left+(n.left-a.left)*o/s,l=0==i.curvature?a.top+(n.top-a.top)*o/s:i.curvature*Math.pow(d-i.vertex_left,2)+i.vertex_top;if(null!=n.width&&null!=n.height){var h=s/2,r=n.width-(n.width-a.width)*Math.cos(h>o?0:(o-h)/(s-h)*Math.PI/2),m=n.height-(n.height-a.height)*Math.cos(h>o?0:(o-h)/(s-h)*Math.PI/2);e.css({width:r+"px",height:m+"px","font-size":Math.min(r,m)+"px"})}e.css({left:d+"px",top:l+"px"}),i.count++;var u=window.requestAnimationFrame(t.proxy(this.move,this));o==s&&(window.cancelAnimationFrame(u),i.onEnd.apply(this))},s.destory=function(){e.remove()},s.init(a)},t.fn.fly=function(i){return this.each(function(){void 0==t(this).data("fly")&&t(this).data("fly",new t.fly(this,i))})}}(jQuery),ht.detail={init:function(){this.loadData(),this.getTax(),this.bindEvent()},getTax:function(){var t="True"==ht.detail.goodInfo.is_abroad?0:1,i=ht.core.ops.tax[t];this.maxPrice=i.maxPrice,this.taxRate=i.taxRate,this.payTax=i.payTax},tempBuyAmount:0,loadData:function(){ht.detail.goodInfo=window.__getGoodsInfo();var t=__getGoodsDetail(),i="http://cdn.qqqg.com/web/images/blank.gif",a=/(<img [^>]*src=['"])([^'"]+[^>]*>)/gi,o="全球抢购";t=t.replace(a,"$1"+i+'" class="j-lazy"data-width="@640w" alt="'+o+'"  data-src="$2'),$("#js_goodsdetail").html(t);var s={lowStocks:ht.detail.goodInfo.lowStocks,cartCount:ht.detail.goodInfo.cart_count>99?"99+":ht.detail.goodInfo.cart_count};$("#templateBtns").tmpl(s).appendTo("#m-buybar");var e={main_pic:ht.detail.goodInfo.main_pic,title:ht.detail.goodInfo.title,price:ht.detail.goodInfo.price,stockTxt:"True"==this.goodInfo.lowStocks?"库存不足":"库存充足",stockTip:parseInt(ht.detail.goodInfo.min_limit_quantity,10)>1?"最少限购数量"+ht.detail.goodInfo.min_limit_quantity:"",tempBuyAmount:this.tempBuyAmount>this.goodInfo.min_limit_quantity?this.goodInfo.tempBuyAmount:this.goodInfo.min_limit_quantity};$("#templateSku").tmpl(e).appendTo("#m-sku")},bindEvent:function(){_this=this;var t=$("#m-buybar");t.on("click","#buyNow",function(t){if(!$(this).hasClass("dis")){var a=i.val();if(a=parseInt(a,10),"确认购买"==$(this).html())return $("#buyNowFm .fmItem_id").val(ht.detail.goodInfo.itemId),$("#buyNowFm .fmItem_tempBuyAmount").val(a),void $("#buyNowFm")[0].submit();ht.detail.getPrice(a),$(".m-sku-mask").addClass("show"),$(".m-sku").addClass("show"),$(this).addClass("show").addClass("btn-large").html("确认购买"),$("#addCart").addClass("hide")}}).on("click","#addCart",function(t){if(!$(this).hasClass("dis")){if("确认加入"==$(this).html())return $("#popUp").show(),_this.flyToCart($(this),t),void setTimeout(function(){},1e3);$(".m-sku-mask").addClass("show"),$(".m-sku").addClass("show"),$("#buyNow").addClass("hide"),$(this).html("确认加入").addClass("show").addClass("btn-large"),$("#cart").removeClass("hide")}}),$("#m-sku").on("click","#topbar-back",function(){$(".m-sku-mask").removeClass("show"),$(".m-sku").removeClass("show"),$("#addCart").removeClass("hide").html("加入购物车").removeClass("flyNow"),$("#buyNow").removeClass("btn-large").removeClass("hide").html("立即购买").removeClass("dis"),$("#cart").removeClass("hide")});var i=$("#tempBuyAmountObj"),a=$(".minus"),o=$(".plus");o.on("click",function(){var t=i.val();return t==ht.detail.goodInfo.max_limit_quantity?($(this).addClass("dis"),void $(this).children().addClass("u-icn14-2")):(t=parseInt(t,10)+1,t>1?a.removeClass("dis").children().removeClass("u-icn14-3"):a.addClass("dis").children().addClass("u-icn14-3"),"True"==ht.detail.goodInfo.is_abroad&&(ht.detail.goodInfo.price*t>ht.detail.maxPrice&&($(this).addClass("dis"),$(this).children().addClass("u-icn14-2")),ht.detail.getPrice(t)),void i.val(t))}),a.on("click",function(){if($(this).hasClass("dis"))return!1;var t=i.val();return t==ht.detail.goodInfo.min_limit_quantity?($(this).addClass("dis"),!1):(t=parseInt(t,10)-1,1==t?a.addClass("dis").children().addClass("u-icn14-3"):a.removeClass("dis").children().removeClass("u-icn14-3"),o.removeClass("dis"),o.children().removeClass("u-icn14-2"),"True"==ht.detail.goodInfo.is_abroad&&ht.detail.getPrice(t),void i.val(t))}),$("#u-slide-detail").on("click",function(){var t=$("#js_goodsdetail").offset().top;$("body,html").animate({scrollTop:t},1e3)})},flyToCart:function(t,i){if($(this).hasClass("dis"))return!1;var a=$("#cart").offset(),o=$("#showImg").attr("src"),s=$('<img class="u-flyer" src="'+o+'">');s.fly({start:{left:$("#showImg").offset().left,top:$("#showImg").offset().top},end:{left:a.left+10,top:a.top+10,width:0,height:0},onEnd:function(){var t={item_id:ht.detail.goodInfo.itemId,item_num:$("#tempBuyAmountObj").val()};$.getJSON("/member/addcart",t,function(t){if(200==t.state){var i=t.account;i=i>99?"99+":i,$("#cart .count").text(i)}$("#popUp").hide(),$("#topbar-back").click()}),this.destory()}})},getPrice:function(t){var i=$("#overAmount");return 0==ht.detail.payTax?void i.removeClass("show"):void(ht.detail.goodInfo.price*t>ht.detail.maxPrice?(i.addClass("show"),$("#buyNow,#addCart").addClass("dis")):(i.removeClass("show"),$("#buyNow,#addCart").removeClass("dis")))}},$(function(){ht.detail.init()});