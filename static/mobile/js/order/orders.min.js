!function(){ht.orders={list:{init:function(){var t=ht.core.getQuery("state");t&&(ht.orders.list.state=t),console.log(t),ht.core.dialog.init(),this.getFirstData(),this.bindEvent(),this.compileTempl()},getOrderStatus:function(t,e,a){if(1==t){if(0==e)return this.getOStatus(0);if(1==e){if(0==a)return this.getOStatus(1);if(1==a)return this.getOStatus(2);if(2==a)return this.getOStatus(4)}}else{if(2==t)return this.getOStatus(4);if(3==t)return this.getOStatus(6);if(4==t)return this.getOStatus(6)}},getOStatus:function(t){var e={0:"等待付款",1:"等待发货",2:"已发货",3:"确认收货",4:"交易成功",5:"交易失败",6:"交易关闭"},a={key:t,txt:e[t+""]};return a},getFirstData:function(){var t=this;this.getData(function(){t.getMoreData()})},compileTempl:function(){var t='<ul class="tr"><li class="td f-tac tab {{if index==0}}tab-cur{{/if}} "><span>全部</span></li><li class="td f-tac tab {{if index==1}}tab-cur{{/if}} "><span class="ordertype">待付款 {{if waiting_pay>0}}<span class="ordercount">{{if waiting_pay>99}}99+{{else}}{{= waiting_pay}}{{/if}}</span>{{/if}}</span> </li> <li class="td f-tac tab  {{if index==2}}tab-cur{{/if}} "><span class="ordertype">待发货{{if waiting_deliver>0}}<span class="ordercount">{{if waiting_deliver>99}}99+{{else}}{{= waiting_deliver}}{{/if}}</span>{{/if}}</span>  </li> <li class="td f-tac tab  {{if index==3}}tab-cur{{/if}} "><span class="ordertype">待收货{{if waiting_recieve>0}}<span class="ordercount">{{if waiting_recieve>99}}99+{{else}}}{{= waiting_recieve}}{{/if}}</span>{{/if}}</span> </li> </ul>';$.template("orderTabsTemplate",t)},parseData:function(t){for(var e=QTIMES.date.date_to_str("%Y-%m-%d %H:%i:%s"),a=0,i=0,r=t.length;r>i;i++){t[i].oTime=e(new Date(1e3*t[i].gmt_created)),a=0;for(var s=0,o=t[i].items.length;o>s;s++)t[i].items[s].goodPhoto=ht.core.getOnePic(t[i].items[s].main_pic),a+=t[i].items[s].buy_nums,t[i].items[s].order_no=t[i].order_no,t[i].items[s].order_id=t[i].id;t[i].goodsCount=a;var n=this.getOrderStatus(t[i].status,t[i].pay_status,t[i].delivery_status);t[i].orderStatusText=n.txt,t[i].tomsOrderStatus=n.key}return t},getData:function(t){if(1==ht.orders.list.hasLoaded)return void $("#m-listloading").hide();var e=this,a={page:ht.orders.list.page,state:0==ht.orders.list.state?"":ht.orders.list.state,_xsrf:$("input[name=_xsrf]").val()};$.post("/order/orders.html",a,function(a){$("#m-listloading").hide();var i=JSON.parse(a);if(200==i.state){var r=i.data.result;if(e.objOrderTabs={index:ht.orders.list.state,waiting_pay:i.waiting_pay,waiting_deliver:i.waiting_deliver,waiting_assess:i.waiting_assess,waiting_recieve:i.waiting_recieve},$("#orderTab").empty(),$.tmpl("orderTabsTemplate",e.objOrderTabs).appendTo("#orderTab"),0==r.length)return ht.orders.list.hasLoaded=1,void(0==$("#m-orderbox .m-orderitem").length&&$("#emptyOrder").show());r=e.parseData(r),$("#templateOrderList").tmpl(r).appendTo("#m-orderbox"),ht.core.lazyLoad(),ht.orders.list.page++,t&&t()}})},page:1,objOrderTabs:{},state:"",hasLoaded:0,getMoreData:function(){var t=$("#m-listloading");ht.core.waterFall(200,t,function(){ht.orders.list.getData(function(){t.hide()})})},changeObjOrderTabs:function(t){this.setObjOrderTabs(t),this.setTabsCount(this.objOrderTabs)},setObjOrderTabs:function(t){switch(t){case"0":this.objOrderTabs.waiting_pay=this.objOrderTabs.waiting_pay>0?parseInt(this.objOrderTabs.waiting_pay,10)-1:this.objOrderTabs.waiting_pay;break;case"1":this.objOrderTabs.waiting_deliver=this.objOrderTabs.waiting_deliver>0?parseInt(this.objOrderTabs.waiting_deliver,10)-1:this.objOrderTabs.waiting_deliver;break;case"3":this.objOrderTabs.waiting_recieve=this.objOrderTabs.waiting_recieve>0?parseInt(this.objOrderTabs.waiting_recieve,10)-1:this.objOrderTabs.waiting_recieve}},setTabsCount:function(t){$("#orderTab").empty(),$.tmpl("orderTabsTemplate",t).appendTo("#orderTab"),0==$("#m-orderbox .m-orderitem").length&&$("#emptyOrder").show()},bindEvent:function(){var t=this,e=[{_aniClass:"show",confirm:{text:"你收到包裹了吗？",btns:[{text:"确定",action:"ok"},{text:"取消",action:"close"}]}}],a=[{_aniClass:"show",confirm:{text:"你确定取消订单吗？",btns:[{text:"确定",action:"ok"},{text:"取消",action:"close"}]}}];$("#orders").on("click",".tab",function(){$("#m-listloading").show(),$("#emptyOrder").hide();var e=$(this).index();$("#m-orderbox").empty(),ht.orders.list.hasLoaded=0,ht.orders.list.page=1,ht.orders.list.state=e,t.getData()}).on("click",".confirmReceipt",function(){var a=$(this),i=a.closest(".m-orderitem"),r=i.attr("order-tomsStatus");ht.core.dialog.show(e),$("body").on("click","#m-dialog .ok",function(){var e=(i.attr("data-no"),i.attr("data-id")),s={_xsrf:$("input[name=_xsrf]").val()};$.ajax({url:"/member/order_"+e+".html",data:s,type:"PUT",success:function(e){e=JSON.parse(e),200==e.state&&(t.changeObjOrderTabs(r),a.remove(),i.find(".m-btnbox").append('<a href="javascript:void(0)" class="u-btn2 m-orderbtn hasRecive">交易成功</a>'),ht.core.dialog.hide())}})})}).on("click",".cancelOrder",function(){var e=$(this),i=e.closest(".m-orderitem"),r=i.attr("order-tomsStatus");ht.core.dialog.show(a),$("body").on("click","#m-dialog .ok",function(){var a=(i.attr("data-no"),i.attr("data-id")),s={_xsrf:$("input[name=_xsrf]").val()};$.ajax({url:"/member/order_"+a+".html",data:s,type:"DELETE",success:function(a){a=JSON.parse(a),200==a.state&&(t.changeObjOrderTabs(r),e.remove(),i.find(".ordertype").html("交易关闭"),i.find(".m-btnbox").html('<a href="javascript:void(0)" class="u-btn2 m-orderbtn u-btn3-yq">交易关闭</a>'),ht.core.dialog.hide())}})})})}}}}(),$(function(){ht.orders.list.init()});