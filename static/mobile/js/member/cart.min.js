!function(){ht.cart={init:function(){ht.core.dialog.init(),this.getEmptyTemp(),this.getData(),this.bindEvent()},getTaxByWarehouse:function(t){var e="True"==t?0:1,a=ht.core.ops.tax[e];return a},oriData:{},getEmptyTemp:function(){var t='<section class="m-emtpy f-tac"><span class="u-icn5"></span><p class="tiptxt">购物车里空空如也，赶紧去逛逛吧！</p><a class="u-btn" href="/">去逛逛</a></section>';$("#appfootmenu")[0]&&(t='<section class="m-emtpy f-tac"><span class="u-icn5"></span><p class="tiptxt">购物车里空空如也，赶紧去逛逛吧！</p><a class="u-btn" href="/app/index.html">去逛逛</a></section>'),$.template("templateEmpty",t)},parseData:function(t){for(var e=0,a=t.length;a>e;e++){t[e].price=0,t[e].goods=t[e].items,t[e].orderIndex=e;for(var i=0,s=t[e].items.length;s>i;i++)t[e].items[i].oIndex=e,t[e].items[i].pIndex=i,t[e].price=t[e].price+t[e].items[i].price,t[e].items[i].main_pic=t[e].items[i].main_pic.indexOf(";")>-1?t[e].items[i].main_pic.split(";")[0]:t[e].items[i].main_pic,t[e].items[i].is_abroad=t[e].is_abroad;t[e].paidPrice=t[e].price,"True"==t[e].is_abroad?(t[e].moneyCount=t[e].total_price+(t[e].tax_acount<=ht.core.ops.tax[0].taxRate?0:t[e].tax_acount),t[e].isOver=t[e].good_counts>1&&t[e].moneyCount>ht.core.ops.tax[0].maxPrice?1:0):(t[e].tax_acount=0,t[e].moneyCount=t[e].total_price,t[e].isOver=0)}return t},getData:function(){var t=this;$("#carts").empty();var e={_xsrf:$("input[name=_xsrf]").val()};$.ajax({url:"/member/cart.html",data:e,type:"PUT",success:function(e){if(e=JSON.parse(e),200==e.state){var a=e.items;$("#cartCount").html("("+e.total_count+")"),a=t.parseData(a),t.oriData=a,0==a.length?$.tmpl("templateEmpty",{}).appendTo("#carts"):$("#templateOrder").tmpl(a).appendTo("#carts")}}})},changeProductNum:function(){var t={item_id:ht.detail.goodInfo.itemId,item_num:$("#tempBuyAmountObj").val()};$.getJSON("/member/addcart",t,function(t){if(200==t.state){var e=t.account;e=e>99?"99+":e,$("#cart .count").text(e)}$("#popUp").hide(),$("#topbar-back").click()})},getGoodObj:function(t){var e=parseInt(t.attr("data-oIndex"),10),a=parseInt(t.attr("data-pIndex"),10),i={orderO:this.oriData,goods:this.oriData[e].items[a],goodsO:this.oriData[e].items,oIndex:e,pIndex:a};return i},getHouseObj:function(t){var e=parseInt(t.attr("data-oIndex"),10),a={orderO:this.oriData,ordersObj:this.oriData[e]};return a},changeCount:function(t,e){var a=this,i=t.closest(".gitm"),s=t.closest(".m-cart"),n=a.getGoodObj(i).goods,o={_xsrf:$("input[name=_xsrf]").val(),item_id:n.id,item_num:e};$.ajax({url:"/member/addcart",data:o,type:"PUT",success:function(t){t=JSON.parse(t),200==t.state&&(a.setChosenNum(s),a.getALLPrice(s),a.getCountNum())}})},getALLPrice:function(t){var e,a,i=this,s=0,n=0;t.find(".chosen").each(function(){e=i.getGoodObj($(this)),a=$(this).find(".buyNum").val(),s=parseFloat(s)+parseFloat(parseInt(a,10)*e.goods.price);var t=e.goods.tax_rate;"True"==e.is_abroad?0!=t&&(n+=parseFloat(parseInt(a,10))*parseFloat(e.goods.price)*t/100):n=0});var o=i.getHouseObj(t).ordersObj;s=s.toFixed(2),n=n.toFixed(2);var r=0;parseFloat(n)<=ht.core.ops.tax[0].taxRate?(r=0,t.find(".tariffLbl").addClass("del")):(r=parseFloat(n),t.find(".tariffLbl").removeClass("del")),t.find(".tariff").text(n),t.find(".total_price").text(s);var n=0,c=parseFloat(s)+r;t.find(".moneyCount").text(c);var m=parseFloat(t.find(".finalChooseNum").text());"True"==o.is_abroad?(s>ht.core.ops.tax[0].maxPrice&&m>1?(t.find(".settlementBtn").addClass("u-btn-disab"),t.find(".u-overtip").show()):(t.find(".settlementBtn").removeClass("u-btn-disab"),t.find(".u-overtip").hide()),0==m&&(t.find(".settlementBtn").addClass("u-btn-disab"),t.find(".u-overtip").hide())):0==m?t.find(".settlementBtn").addClass("u-btn-disab"):t.find(".settlementBtn").removeClass("u-btn-disab")},setChosenNum:function(t){var e=0;t.find(".chosen .buyNum").each(function(){e+=parseInt($(this).val(),10)});var a=e;t.find(".finalChooseNum").text(a)},getCountNum:function(){var t=0;$(".buyNum").each(function(){t+=parseInt($(this).val(),10)}),$("#cartCount").html("("+t+")")},bindEvent:function(){var t=this;$("#carts").on("click",".checkAll",function(){var e=$(this).closest(".m-cart");1==$(this)[0].checked?e.find(".m-cartgoods").find("input[type=checkbox]").each(function(){$(this)[0].checked="checked";var t=$(this).closest(".gitm");t.addClass("chosen")}):e.find(".m-cartgoods").find("input[type=checkbox]").each(function(){$(this)[0].checked="",$(this).siblings("input[name=item_id]").remove();var t=$(this).closest(".gitm");t.removeClass("chosen")}),t.setChosenNum(e),t.getALLPrice(e)}).on("click",".checkone",function(){var e=$(this).closest(".m-cart"),a=$(this).closest(".gitm"),i=t.getGoodObj(a);if(1==$(this)[0].checked){if(!$(this).siblings("input[name=item_id]")[0]){var s=i.goods.id;$(this).before('<input type="hidden" name="item_id" value="'+s+'">')}a.addClass("chosen")}else a.removeClass("chosen"),$(this).siblings("input[name=item_id]").remove();t.setChosenNum(e),t.getALLPrice(e)});var e=[{_aniClass:"show",confirm:{text:"确定删除该商品吗？",btns:[{text:"确定",action:"ok"},{text:"取消",action:"close"}]}}];$("#carts").on("click",".u-remove",function(){var a=$(this),i=$(this).closest(".m-cart"),s=a.closest(".gitm");ht.core.dialog.show(e);var n=t.getGoodObj(s);$("body").on("click","#m-dialog .ok",function(){var e={_xsrf:$("input[name=_xsrf]").val(),item_id:n.goods.id};$.ajax({url:"/member/cart.html",data:e,type:"DELETE",success:function(e){e=JSON.parse(e),200==e.state&&($("#m-dialog").remove(),1==n.goodsO.length&&s.closest(".m-cart").remove(),s.remove(),0==$("#carts .m-cart").length?($.tmpl("templateEmpty",{}).appendTo("#carts"),$("#cartCount").html("(0)")):(t.setChosenNum(i),t.getALLPrice(i)),t.getCountNum())}})})}),$("#carts").on("click",".settlementBtn",function(){$(this).hasClass("u-btn-disab")||$(this).closest("form")[0].submit()});var a;$("#carts").on("click",".plus",function(){var e=$(this),i=$(this).closest(".gitm"),s=t.getGoodObj(i).goods,n=s.min_limit_quantity,o=s.max_limit_quantity,r=$(this).siblings(".buyNum"),c=r.val();if(c==o)return!1;r.val(parseInt(c,10)+1),r.val()>n&&$(this).siblings(".minus").removeClass("z-dis"),r.val()==o&&$(this).addClass("z-dis"),clearTimeout(a);var c=r.val();i.find(".goodAmount").text(c),a=setTimeout(function(){t.changeCount(e,c)},500)}).on("click",".minus",function(){var e=$(this),i=$(this).closest(".gitm"),s=t.getGoodObj(i).goods,n=s.min_limit_quantity,o=s.max_limit_quantity,r=$(this).siblings(".buyNum"),c=r.val();$(this).hasClass("z-dis")||(r.val(parseInt(c,10)-1),c=r.val(),c==n&&$(this).addClass("z-dis"),o>c&&$(this).siblings(".plus").removeClass("z-dis"),i.find(".goodAmount").text(c),clearTimeout(a),a=setTimeout(function(){t.changeCount(e,c)},500))})}},$(function(){ht.cart.init()})}();