!function(t,i){ht.commt={init:function(){this.rate.init(),this.valid.init(),this.bindEvent()},assess_level:["差评","中评","好评"],rate:{init:function(){},tips:["差评","较差","一般","满意","非常满意"]},valid:{init:function(){datatype=ht.util.validformParam.datatype,$(".cmtform").each(function(){var t=$(this);t.Validform({btnSubmit:".btnCommt",tiptype:3,datatype:ht.util.validformParam.datatype,callback:function(){return ht.util.popAlert.loading(function(){var i=[];t.find(".myshowpng").each(function(){i.push($(this)[0].src)});var e=i.join(";"),o={item_id:t.attr("data-item-id"),order_id:t.attr("data-order-id"),order_no:t.attr("data-order-no"),assess_level:t.find("input[name=assess_level]:checked").val(),comment:t.find("textarea[name=comment]").val(),show_imgs:e,_xsrf:$("input[name=_xsrf]").val()};$.post("/item/comment.html",o,function(i){if(i=JSON.parse(i),200==i.state){t.find(".listDis").empty();var e=i.data;if(e.comment_id=i.comment_id,e.boysphotos=[],""!=e.show_imgs){for(var s=[],a=e.show_imgs.split(";"),n=0,r=a.length;r>n;n++)s.push({tomsPhoto:a[n]});e.boysphotos=s}e.item_id=o.item_id,e.assess=ht.commt.assess_level[parseInt(e.assess_level)],$("#templateHisCmtInfos").tmpl(e).appendTo(t.find(".listDis")),t.find(".blueRight").show(),$.unblockUI()}})}),!1}})})}},bindEvent:function(){$("#rateCon").on("change",".file",function(){var t=$(this).val().toLowerCase();if(0==ht.util.checkPictureType(t))return alert("只支持.gif .png .jpg .jpeg格式图片"),!1;if($(this)[0].files){var i=$(this)[0].size;if(i>3145728)return alert("加载图片失败，头像不能大于3M"),!1}ht.commt.ajaxFileUpload($(this)[0].id)}),$(".showBuyting").on("click",".delPhoto",function(){$(this).closest(".showBuyting").find(".seeupload").show(),$(this).closest(".usersShow").remove()}),$(".hisphotos").click(function(){var t=$(this),i=t.attr("data-src"),e="BlockImage"+Math.random(),o={id:e,dataSrc:i},s=$("#templateHisPhotos").tmpl(o);ht.util.popAlert.run(function(){$.blockUI({css:{top:"50%",left:"50%",marginLeft:"-260px",marginTop:"-260px",width:"520px",height:"520px",textAlign:"justify"},message:s})})}),$(".commtAgain").on("click",function(){var t=$(this).closest(".dataList");t.find(".disCmtAgain").show()}),$("#rateCon").on("click",".btnCommtAgain",function(){var t=$(this),i=$(this).closest(".commtAgainform"),e=i;ht.util.popAlert.loading();var o=[];e.find(".myshowpng").each(function(){o.push($(this)[0].src)});var s=o.join(";"),a={comment_id:e.attr("data-comment-id"),addition_comment:e.find("textarea[name=comment]").val(),add_show_imgs:s,_xsrf:$("input[name=_xsrf]").val()};$.post("/item/comment.html",a,function(e){if(e=JSON.parse(e),200==e.state){var o=e.data;if(o.boysphotos=[],""!=o.add_show_imgs){for(var s=[],a=o.add_show_imgs.split(";"),n=0,r=a.length;r>n;n++)s.push({tomsPhoto:a[n]+"@100w",tomsPhotoBig:a[n]+"@400w"});o.boysphotos=s}$("#templateHisCmtAgainInfos").tmpl(o).appendTo(i.parent().parent()),t.remove(),i.parent().remove(),$.unblockUI()}})})},ajaxFileUpload:function(t){var i=$("#"+t).prev(".loading"),e=$("#"+t).closest(".showBuyting");return e.find(".seeupload").hide(),i.show(),$.ajaxFileUpload({url:"/item/comment/uploadimage.html",secureuri:!1,fileElementId:t,dataType:"json",success:function(i,o){r=i,200==r.state&&($("#"+t).parent().after('<li class="usersShow"><div class="userphotos"><a href="javascript:void(0)" class="delPhoto"></a><img alt="图片"  class="myshowpng" src="'+r.url+'@100w"></div></li>'),5==e.find(".usersShow").length?e.find(".seeupload").hide():e.find(".seeupload").show())},error:function(t,i,e){},complete:function(){i.hide()}}),!1}},$(function(){ht.commt.init()})}(window);