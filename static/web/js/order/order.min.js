!function(t,e){ht.order={init:function(){$("#cart")[0]&&this.cart.init(),$("#orders")[0]&&this.orders.init(),$("#payway")[0]&&this.payway.init(),$("#orderdetail")[0]&&this.orderdetail.init()},cart:{init:function(){this.calculationTariff(),$(".askIcon").mouseover(function(){$(this).next(".tip-wrap").show()}),$(".tip-wrap").mouseout(function(){$(this).hide()}),$(".trHeight .checkboxIcons").click(function(){var t=$(this).closest("tr.trHeight"),e=$(this).closest(".productTable");if($(this).hasClass("checkboxSimulateChecked"))$(this).removeClass("checkboxSimulateChecked"),t.removeClass("chosen"),$(this).siblings("input[name=item_id]").remove();else{if(!$(this).siblings("input[name=item_id]")[0]){var a=$(this).attr("data-itemid");$(this).before('<input type="hidden" name="item_id" value="'+a+'">')}$(this).addClass("checkboxSimulateChecked"),t.addClass("chosen")}var e=$(this).closest(".productTable"),s=0;e.find(".chosen .buyNum").each(function(){s+=parseInt($(this).val(),10)});var i=s;e.find(".finalChooseNum").text(i),ht.order.cart.getALLPrice(e),$(".trHeight .checkboxSimulateChecked").length==$(".trHeight .checkboxIcons").length?e.find(".checkAll").addClass("checkboxSimulateChecked"):e.find(".checkAll").removeClass("checkboxSimulateChecked")}),$(".checkAll").click(function(){var t=$(this).closest(".productTable");$(this).hasClass("checkboxSimulateChecked")?(t.find(".checkboxIcons").removeClass("checkboxSimulateChecked"),t.find(".submitCartBtn").addClass("oOrgBtnDis"),t.find(".ordersub").addClass("dis"),t.find(".goToChoice").show(),t.find(".trHeight").removeClass("chosen"),t.find("input[name=item_id]").remove()):(t.find(".checkboxIcons").addClass("checkboxSimulateChecked"),t.find(".submitCartBtn").removeClass("oOrgBtnDis"),t.find(".ordersub").removeClass("dis"),t.find(".goToChoice").hide(),t.find(".trHeight").addClass("chosen"),t.find(".checkboxIcons").each(function(){if(!$(this).siblings("input[name=item_id]")[0]){var t=$(this).attr("data-itemid");$(this).before('<input type="hidden" name="item_id" value="'+t+'">')}}),t.find("input[name=item_id]"));var e=0;t.find(".chosen .buyNum").each(function(){e+=parseInt($(this).val(),10)});var a=e;t.find(".finalChooseNum").text(a),ht.order.cart.getALLPrice(t)}),$(".submitCartBtn").click(function(){$(this).hasClass("oOrgBtnDis")||$(this).closest("form")[0].submit()}),$(".buyNum").each(function(){var t=parseInt($(this).attr("min_count"),10),e=parseInt($(this).attr("max_Count"),10),a=$(this).siblings(".addNum"),s=$(this).siblings(".reduceNum");$(this).val()==t&&s.addClass("ctrNumDis"),$(this).val()==e&&a.addClass("ctrNumDis")});var t;$(".buyBox .addNum").click(function(){var e=$(this),a=$(this).siblings(".buyNum"),s=parseInt(a.attr("min_count"),10),i=parseInt(a.attr("max_Count"),10),r=a.val();if(r==i)return!1;a.val(parseInt(r,10)+1),a.val()>s&&e.siblings(".reduceNum ").removeClass("ctrNumDis"),a.val()==i&&$(this).addClass("ctrNumDis"),clearTimeout(t);var r=a.val();t=setTimeout(function(){ht.order.cart.changeCount(e,r)},500)}),$(".buyBox .reduceNum").click(function(){var e=$(this),a=$(this).siblings(".buyNum"),s=parseInt(a.attr("min_count"),10),i=parseInt(a.attr("max_Count"),10);if(!(a.val()<=s||$(this).hasClass("ctrNumDis"))){a.val(parseInt(a.val(),10)-1),a.val()==s&&$(this).addClass("ctrNumDis"),a.val()<i&&$(this).siblings(".addNum").removeClass("ctrNumDis"),clearTimeout(t);var r=a.val();t=setTimeout(function(){ht.order.cart.changeCount(e,r)},500)}}),$(".buyNum").keyup(function(){var t=$(this).siblings(".reduceNum"),e=$(this).siblings(".addNum"),a=parseInt($(this).attr("min_count"),10),s=parseInt($(this).attr("max_Count"),10);if(1==$(this).val().length){var i=$(this).val().replace(/[^1-9]/g,""),r=""==i||a>i?a:i;$(this).val(r)}else{var i=$(this).val().replace(/\D/g,""),r=""==i||a>i?a:i;r=i>s?s:i,$(this).val(r)}$(this).val()>a?t.removeClass("ctrNumDis"):t.addClass("ctrNumDis"),$(this).val()>=s?e.addClass("ctrNumDis"):e.removeClass("ctrNumDis")}).blur(function(){var t=$(this),e=t.val();ht.order.cart.changeCount(t,e)}),this.bindEvent()},calculationTariff:function(){$(".productTable").each(function(){if("False"==$(this).attr("is_abroad"))return!1;var t=parseInt($(this).find(".finalChooseNum").text(),10),e=parseInt($(this).find(".totalPrice").text(),10);t>1&&e>ht.util.ops.tax[0].maxPrice&&($(this).find(".goToPayNotice").show(),$(this).find(".submitCartBtn").addClass("oOrgBtnDis"),$(this).find(".ordersub").addClass("dis"))})},getALLPrice:function(t){var e=0;t.find(".chosen .amountMoney").each(function(){e=parseFloat(e)+parseFloat($(this).text())}),e=e.toFixed(2),t.find(".totalPrice").text(e);var a=0,s=parseFloat(t.find(".discount").text()),i=0;t.find(".chosen .buyNum").each(function(){var e=parseInt($(this).attr("tax_rate"),10);"False"==t.attr("is_abroad")&&(i=0,e=0),0!=e&&(i+=parseFloat($(this).val())*parseFloat($(this).attr("price"))*e/100)}),i=i.toFixed(2),t.find(".tariff").text(i);var r=0;parseFloat(i)<=ht.util.ops.tax[0].taxRate?(r=0,t.find(".tariffLbl").addClass("lineThrough")):(r=parseFloat(i),t.find(".tariffLbl").removeClass("lineThrough")),a=parseFloat(e)-s+r,a=a>0?a:0,a=a.toFixed(2),t.find(".moneyCount").text(a);var d=parseFloat(t.find(".finalChooseNum").text()),n=!0;"True"==t.attr("is_abroad")&&(n=e>ht.util.ops.tax[0].maxPrice),n&&d>1?(t.find(".submitCartBtn").addClass("oOrgBtnDis"),t.find(".ordersub").addClass("dis"),t.find(".goToPayNotice").show()):(t.find(".submitCartBtn").removeClass("oOrgBtnDis"),t.find(".ordersub").removeClass("dis"),t.find(".goToPayNotice").hide()),0==t.find(".trHeight .checkboxSimulateChecked").length?(t.find(".submitCartBtn").addClass("oOrgBtnDis"),t.find(".ordersub").addClass("dis"),t.find(".goToChoice").show()):("False"==t.attr("is_abroad")&&(t.find(".submitCartBtn").removeClass("oOrgBtnDis"),t.find(".ordersub").removeClass("dis")),t.find(".goToChoice").hide())},changeCount:function(t,e){var a=t.closest("tr.trHeight"),s=t.closest(".productTable"),i={_xsrf:$("input[name=_xsrf]").val(),item_id:a.attr("data-id"),item_num:e};$.ajax({url:"/order/cart.html",data:i,type:"PUT",success:function(t){if(t=JSON.parse(t),200==t.state){var i=e*a.find(".price").text();a.find(".amountMoney .strongSize").text(i),ht.order.cart.setChosenNum(s),ht.order.cart.getALLPrice(s)}}})},setChosenNum:function(t){var e=0;t.find(".chosen .buyNum").each(function(){e+=parseInt($(this).val(),10)});var a=e;t.find(".finalChooseNum").text(a)},bindEvent:function(){$("#cart").on("click",".cartShutBtn",function(){var t=$(this),e=t.closest(".productTable"),a=t.closest("tr.trHeight");ht.util.popAlert.run(function(){var t=ht.util.popAlert.confirm("您确定要删除吗？","iDialogDelCart");$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:t}),$("#iDialogDelCart .iDialogYes").click(function(){var t={_xsrf:$("input[name=_xsrf]").val(),item_id:a.attr("data-id")};$.ajax({url:"/order/cart.html",data:t,type:"DELETE",success:function(t){t=JSON.parse(t),200==t.state&&(a.remove(),0==$(".productTable .trHeight").length?($("#productEmpty").show(),$("form[name=fmCart]").remove()):(ht.order.cart.setChosenNum(e),ht.order.cart.getALLPrice(e)))}}),$.unblockUI()})})})}},orders:{init:function(){ht.util.location.init(),"False"==$("#is_abroad").val()&&$(".item-idcard").remove(),$(".m-checkbox").click(function(){$(this).hasClass("m-checked")?$(this).removeClass("m-checked"):$(this).addClass("m-checked")}),0==$("#user-addresses .addresses").size()?$("#addNewAd").show():$("#addNewAd").hide(),this.bindEvent()},setProCityArea:function(){var t=$("#provicecityarea .result");$("#province").val(t.eq(0).attr("value")).attr("data-title",t.eq(0).html()),$("#city").val(t.eq(1).attr("value")).attr("data-title",t.eq(1).html()),$("#area").val(t.eq(2).attr("value")).attr("data-title",t.eq(2).html())},bindEvent:function(){var t=this;$("#addressfm").Validform({btnSubmit:"#addressSubmit",btnReset:"",tiptype:3,ignoreHidden:!1,ajaxPost:!0,datatype:ht.util.validformParam.datatype,beforeCheck:function(t){},beforeSubmit:function(e){t.setProCityArea()},ajaxpost:{error:function(t,e){}},callback:function(t){if("y"!=t.status)return $.Showmsg(t.info),!1;setTimeout(function(){$.Hidemsg()},1e3);var e=$("#province").attr("data-title")+$("#city").attr("data-title")+$("#area").attr("data-title")+$("#address").val(),a=[{name:$("#name").val(),addressdetail:e,phone:$("#phone").val(),addressid:t.addressId,addressCheck:$("#addressSubmit").attr("data-check")}];if($("#addressfm input[name=address_id]")[0]){var s=$("#addressfm input[name=address_id]").val(),i=$("#user-addresses .addresses[data-id="+s+"]");i.empty(),$("#templateAddressesIn").tmpl(a).appendTo(i)}else $("#user-addresses .adrLabel").removeClass("addressCheck"),$("#address-header").after($("#templateaddress").tmpl(a)),$("#user-addresses .adrLabel:first").addClass("addressCheck");$("#addNewAd").hide(),$("html,body").animate({scrollTop:$("#user-addresses").offset().top},200)}}),$("#addNewAd .closeIcon").click(function(){$("#addNewAd").hide()}),$("#font_card,#back_card").change(function(){$(this).parent().next(".filesTxt").html($(this).val())}),$("#user-addresses").on("click",".addresses",function(){$(".adrLabel").removeClass("addressCheck"),$(this).find(".adrLabel").addClass("addressCheck"),$("#font_card,#back_card").val(""),$("#idCardPhotos .filesTxt").html(""),"True"==$(this).attr("data-card-img")&&$("#idCardPhotos").hide()}),$("#user-addresses").on("click",".setDefault",function(){var t={address_id:$(this).closest(".addresses").attr("data-id")},e=$(this);return $.get("/member/address.html",t,function(t){t=JSON.parse(t),200==t.state&&(e.next(".default")[0]||($("#user-addresses .default").after('<a href="javascript:void(0)" class="setDefault">设为默认</a>').remove(),e.after('<span class="default">默认地址</span>'),e.remove()))}),!1}),$("#user-addresses").on("click",".mod",function(){$("#addNewAd .strong-header").html("修改收货地址");var e=$(this),a=e.closest(".addresses");strCheck=a.find(".adrLabel").hasClass("addressCheck")?"addressCheck":"",$("#addressSubmit").attr("data-check",strCheck);var s={operation:"query",address_id:a.attr("data-id")},i=s.address_id;return $("#addressfm input[name=address_id]")[0]?$("#addressfm input[name=address_id]").val(i):$("#addressfm").append('<input type="hidden"  name="address_id" value="'+i+'" />'),$.getJSON("/member/address.html",s,function(e){$("#name").val(e.user_name),$("#address").val(e.address),$("#card_num").val(e.card_num),$("#phone").val(e.phone);var a=$(".zp-province .option[title="+e.province+"]"),s=a.attr("value");$(".zp-province .result").html(e.province).attr("value",s),a.addClass("curr");var i={parent_id:s,query_type:"city"};$(".zp-city,.zp-district").remove(),ht.util.location.get(i,ht.util.location.locationClass[1],1,function(){var a=$(".zp-city .option[title="+e.city+"]"),s=a.attr("value");$(".zp-city .result").html(e.city).attr("value",s),a.addClass("curr");var i={parent_id:s,query_type:"area"};ht.util.location.get(i,ht.util.location.locationClass[2],2,function(){var a=$(".zp-district .option[title="+e.area+"]"),s=a.attr("value");$(".zp-district .result").html(e.area).attr("value",s),a.addClass("curr"),$("#myLocation").val("1"),t.setProCityArea(),$(".Validform_checktip").removeClass().addClass("Validform_checktip").empty(),$("html,body").animate({scrollTop:$("#addNewAddress").offset().top},500)})}),$("#addNewAd").show()}),!1}),$("#user-addresses").on("click",".del",function(){var t=$(this);return ht.util.popAlert.run(function(){var e=ht.util.popAlert.confirm("您确定要删除吗？","iDialogDelAddress");$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:e}),$("#iDialogDelAddress .iDialogYes").click(function(){var e={_xsrf:$("input[name=_xsrf]").val(),address_id:t.closest(".addresses").attr("data-id")};$.ajax({url:"/member/address.html",data:e,type:"DELETE",success:function(e){e=JSON.parse(e),200==e.state&&(t.closest(".addresses").remove(),$("#addressfm")[0].reset(),$(".Validform_checktip").removeClass().addClass("Validform_checktip"),0==$("#user-addresses .addresses").size()?$("#addNewAd").show():$("#addNewAd").hide())}}),$.unblockUI()})}),!1}),$("#submitOrderBtn").click(function(){function t(){var t="身份证图片格式错误",e="请上传身份证正反面",a=$("#wrongimg"),s=!0;if(""==$("#font_card").val()||""==$("#back_card").val())return a.addClass("Validform_wrong").html(e).show(),s=!1;if(""!=$("#font_card").val()){if(0==ht.util.checkPictureType($("#font_card").val()))return a.addClass("Validform_wrong").html(t).show(),s=!1;a.hide()}if(""!=$("#back_card").val()){if(0==ht.util.checkPictureType($("#back_card").val()))return a.addClass("Validform_wrong").html(t).show(),s=!1;a.hide()}return s=!0}if(0==$("#user-addresses .addresses").size())return ht.util.popAlert.run(function(){var t=ht.util.popAlert.alert("请先填写邮寄地址！");$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:t})}),!1;var e=$("#user-addresses .addressCheck").parent().attr("data-id");if($("#address_id").val(e),""==$("#address_id").val())return ht.util.popAlert.run(function(){var t=ht.util.popAlert.alert("请先选择邮寄地址！");$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:t})}),!1;if("True"==$("#is_abroad").val()){if("False"==$(".addressCheck").parent().attr("data-card-num"))return ht.util.popAlert.run(function(){var t=ht.util.popAlert.alert("请填写收货人身份证信息！");$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:t})}),$(".addressCheck").find(".mod").click(),!1}else"False"==$(".addressCheck").parent().attr("data-card-img")&&$("#idCardPhotos").show();if(!$("#idCardPhotos").is(":hidden")){var a=t();if(!a)return!1}return $(".m-checkbox").hasClass("m-checked")?($(".ui-center-loading")[0]||$('<div class="ui-center-loading"></div>').appendTo("body"),$(".ui-mask").show(),void $("#orderSubmitForm")[0].submit()):(ht.util.popAlert.run(function(){var t=ht.util.popAlert.confirm("您是否同意并接受《全球抢购服务协议》？","iDialogDelAgreement");$.blockUI.defaults.css.textAlign="justify",$.blockUI.defaults.css.fontSize=20,$.blockUI({css:{width:"520px"},message:t}),$("#iDialogDelAddress .iDialogYes").click(function(){return $.unblockUI(),ht.order.sendOrder(),!1})}),!1)}),$("#addNewAddress").click(function(){$("#addNewAd .strong-header").html("新增收货地址"),$(".zp-province .result").html("--省/直辖市--").attr("value",""),$(".zp-province .curr").removeClass("curr"),$(".zp-city,.zp-district").remove(),$("#addressfm")[0].reset(),$(".Validform_checktip").removeClass().addClass("Validform_checktip"),$("#addressfm input[name=address_id]").remove(),$("#addNewAd").show()}),$("#m-idcardtip").hover(function(){$(this).next(".m-notice-idcard").show()},function(){$(this).next(".m-notice-idcard").hide()})}},orderdetail:{init:function(){this.bindEvent()},bindEvent:function(){$(".confirmReceived").on("click",function(){var t=$(this);ht.util.popAlert.run(function(){var e=ht.util.popAlert.confirm("您收到包裹了吗？","iDialogRecOrder","确认收货");e=e.replace(/<span>确认<\/span>/g,"<span>已收到货</span>"),$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:e}),$("#iDialogRecOrder .iDialogYes").click(function(){var e=t.attr("data-id"),a={_xsrf:$("input[name=_xsrf]").val()};$.ajax({url:"/order/order_"+e+".html",data:a,type:"PUT",success:function(e){e=JSON.parse(e),200==e.state&&($("#orderdetail .trieTips").html("当前状态：交易成功 "),$("#orderdetail .trieTime").html("交易成功"),t.remove(),$.unblockUI())}})})})}),$("#J_cancelOrderBtn").on("click",function(){var t=$(this);ht.util.popAlert.run(function(){var e=$("#templateCancelOrder").tmpl({id:1});$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:e}),$("#iDialogCancelOrder .result-wrap").click(function(){$("#iDialogCancelOrder .cp-arrow").hasClass("cp-arrow-down")?($("#iDialogCancelOrder .options").show(),$("#iDialogCancelOrder .cp-arrow").removeClass("cp-arrow-down").addClass("cp-arrow-up")):($("#iDialogCancelOrder .options").hide(),$("#iDialogCancelOrder .cp-arrow").removeClass("cp-arrow-up").addClass("cp-arrow-down"))}),$("#iDialogCancelOrder .option").click(function(){$("#iDialogCancelOrder .result").html($(this).html()).attr("value",$(this).attr("value")),$("#iDialogCancelOrder .options").hide(),$("#iDialogCancelOrder .cp-arrow").removeClass("cp-arrow-up").addClass("cp-arrow-down")}),$("#iDialogCancelOrder .cancelOrderBtnOk").click(function(){var e=t.attr("data-id"),a={_xsrf:$("input[name=_xsrf]").val(),cancle_reason:$("#iDialogCancelOrder .result").html()};console&&console.log(a.cancle_reason),$.ajax({url:"/order/order_"+e+".html",data:a,type:"DELETE",success:function(e){e=JSON.parse(e),200==e.state&&($("#orderdetail .trieTips").html("当前状态：交易关闭 "),$("#orderdetail .trieTime").html("交易关闭"),t.parent().remove(),$.unblockUI())}})})})})}},sendOrder:function(e){$.ajax({type:"POST",url:"/order/order.html",data:$("#orderSubmitForm").serializeArray(),success:function(e){e=JSON.parse(e),200==e.state?t.location.href=e.info:ht.util.popAlert.run(function(){var t=ht.util.popAlert.alert(e.info);$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:t})})}})},payway:{init:function(){$("#payway").on("click",".banks",function(){$(this).find(".wrapnRadio").addClass("nRadioChecked"),$(this).find(".bankinfo").addClass("checked"),$(this).siblings().find(".bankinfo").removeClass("checked"),$(this).siblings().find(".wrapnRadio").removeClass("nRadioChecked").addClass("nRadio");var t=$(this).find(".bankinfo").attr("data-action");$("#paywayform").attr("action",t)}),$("#payBtn").click(function(){ht.util.popAlert.run(function(){var e='<div class="iDialogHead"><h1>提示</h1></div><a href="javascript:;" id="paywayCloseIcon" class="closeIcon">×</a>',a="";a+='<div id="paywayDialog" class="iDialogBody">',a+='<div class="iDialogMain">',a+='<div class="prompt">',a+="<ul>",a+='<li class="icon"><i></i>请在第三方支付页面完成付款</li>',a+="<li>付款完成前请不要关闭此窗口</li>",a+="<li></li>",a+='<li><a class="paySuccess" href="javascript:void(0)">我已付款成功</a><a class="otherPayWay" href="javascript:void(0)">付款遇到问题，重新支付</a> ',a+="</li>",a+="<li></li>",a+='<li class="haveProblem"><a href="#">> 联系人工服务</a>',a+="</li>",a+="</ul>",a+="</div>",a+="</div>",a+="</div>",e+=a,$.blockUI.defaults.css.textAlign="justify",$.blockUI({css:{width:"520px"},message:e}),$("#paywayDialog .paySuccess,#paywayDialog .otherPayWay").click(function(){t.location.reload()}),$("#paywayCloseIcon").click(function(){$.unblockUI()})})})}}},$(function(){ht.order.init()})}(window);