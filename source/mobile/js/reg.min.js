;;(function(){ht.regist={
    init:function(){
        this.bindEvent();
    },
    popUp:function(s){
        var $popUp=$('#popUp');
        $popUp.find('.box').html(s);
        $popUp.show();
        setTimeout(function(){$('#popUp').hide();
        },1000);
    },
    setCountDown:function($obj,str){
        var m=parseInt($obj.attr('v'),10);
        var n=m-1;
        if (n>0) {
            $obj.html('重新获取('+n+')').attr('v',n).addClass("btn_enabled");
            var timeout=setTimeout(function(){
                ht.login.setCountDown($obj,str);
            },1000);
        } else {
            clearTimeout(timeout);
            $obj.html(str).removeClass("btn_enabled");
        }
    },
    validate:{
        chkPhone:function(){
            var _this=ht.regist;
            var isOk=false;
            var $phone=$('#phone');
            if($phone.val()==''){
                _this.popUp('请输入手机号码');
            }else if (!/^1\d{10}$/.test($phone.val())){
                _this.popUp('手机号码格式不正确');
            }else{
                isOk=true;
            }
            return isOk;
        },
        chkKapkey:function(){
            var _this=ht.regist;
            var isOk=false;
            var $kapkey=$('#kapkey');
            if($kapkey.val()==''){
                _this.popUp('请输入验证码');
            }else if($kapkey.val().length!=5){
                _this.popUp('验证码错误');
            }else{
                isOk=true;
            }
            return isOk;
        },
        chkSmsCode:function(){
            var _this=ht.regist;
            var isOk=false;
            var $smskey=$('#smskey');
            if($smskey.val()==''){
                _this.popUp('请输入短信验证码');
            }else if($smskey.val().length!=4){
                _this.popUp('短信验证码错误');
            }else{
                isOk=true;
            }
            return isOk;
        },
        chkPassword:function($obj){
            var _this=ht.regist;
            var isOk=false;
            if($obj.val().length<6 || $obj.val().length>18){
                _this.popUp('请输入6-18位字符');
            }else{
                isOk=true;
            }
            return isOk;
        }

    },
    bindEvent:function(){
        var _this=this;
        $('#imgKey').click(function(){
            $(this)[0].src='/common/image_code/?'+Math.random();
        });
        var $acceptFlyme=$('#agree');
        var $acceptError=$('#acceptError')
        $("#rememberField .mzchkbox").click(function(){
            if($acceptFlyme[0].checked){
                $acceptFlyme[0].checked=false;
                $(this).removeClass('weui_icon_checked').addClass('weui_icon_check');
                $acceptError.show();

            }else{
                $acceptFlyme[0].checked=true;
                $(this).removeClass('weui_icon_check').addClass('weui_icon_checked');
                $acceptError.hide();
            }
        });
        var $u=$('#phone'),$ndel=$('#namedel'),$kapkey=$('#kapkey');
        $u.on('keyup',function(){
           if($(this).val()!=''){
               $ndel.show();
           }
        });
        $ndel.on('click',function(){
            $u.val('');
            $(this).hide();
        });

        var $kapkey=$('#kapkey');
        $('#submit').on('click',function(){
            var isPhone=_this.validate.chkPhone();
            var isKapKey=_this.validate.chkKapkey();
            if(!$acceptFlyme[0].checked)
            {
                return false;
            }
            if(isPhone&&isKapKey){
                var _xsrf=$('input[name=_xsrf]').val();
                var param={
                    phone: $u.val(),
                    code:$kapkey.val(),
                    _xsrf:_xsrf
                }
                $.post('/reg.html',param,function(r){
                    var r=JSON.parse(r);
                    if(r.state!=200){
                        _this.popUp(r.info);
                        return false;
                    }
                    $('#step2_txt').html(r.info);
                    $('.step1').hide();
                    $('.step2').show();
                    var timeline=60;
                    $('#getKey').html('重新获取('+timeline+')').attr('v',timeline).addClass("btn_enabled");
                    ht.core.setCountDown($('#getKey'),'获取验证码');
                });
            }
        });



        $('#next').click(function(){
            var isSmsCode=_this.validate.chkSmsCode();
            if(isSmsCode){
                var param={
                    phone: $u.val(),
                    phonecode:$('#smskey').val()
                }
                $.get('/reg.html',param,function(r){
                    var r=JSON.parse(r);
                    if(r.state!=200){
                        _this.popUp(r.info);
                        return false;
                    }
                    $('.step2').hide();
                    $('.step3').show();
                });

            }
        });

        $('#getKey').click(function(){
            if($(this).hasClass('btn_enabled')) {
                return false;
            }
            var param={
                phone:$u.val()
            }
            $.get('/common/phone/code/',param,function(){
                var timeline=60;
                $('#getKey').html('重新获取('+timeline+')').attr('v',timeline).addClass("btn_enabled");
                ht.core.setCountDown($('#getKey'),'获取验证码');
            });

        });

        $('#regSubmit').click(function(){
            var isPwd1=_this.validate.chkPassword($('#password1'));
            var isPwd2=_this.validate.chkPassword($('#password2'));
            if(isPwd1 && isPwd2){
                if($('#password1').val()!=$('#password2').val()){
                    _this.popUp('两次密码输入不一致');
                }
                else{
                    var _xsrf=$('input[name=_xsrf]').val();
                    var param={
                        phone: $u.val(),
                        pwd:$('#password1').val(),
                        smskey:$('#smskey').val(),
                        option:'reg',
                        _xsrf:_xsrf
                    }

                    $.post('/reg.html',param,function(r){
                        var r=JSON.parse(r);
                        if(r.state!=200){
                            _this.popUp(r.info);
                            return false;
                        }else{
                            window.location='/';
                        }
                    });


                }
            }

        });
    }
}})();
$(function(){
    ht.regist.init();
});