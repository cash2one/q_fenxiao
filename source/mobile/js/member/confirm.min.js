;;(function(){
    ht.confirm={
        init:function(){
            ht.core.dialog.init();
            ht.core.popUp.init();
            ht.core.location.init();
            this.bindEvent();
        },
        setOnlyAddress:function(addressData){
            $('#onlyAddress').empty();
            $('#templateOnlyAddress').tmpl(addressData).appendTo('#onlyAddress');
            $('#address_id').val(addressData.id);
        },
        getThisAddress:function(){
            var _this=this;
            var oneId=$('#address_id').val();
            var hasDeleted=1;
            if(_this.dataAddress.length>0){
                for(var i= 0,len=_this.dataAddress.length;i<len;i++){
                    if(_this.dataAddress[i].id==oneId){
                        var index=i;
                        var addressData=_this.dataAddress[index];
                        _this.setOnlyAddress(addressData);
                        hasDeleted=0;
                        return;
                    }
                }
                if(hasDeleted==1){
                    var addressData=_this.dataAddress[0];
                    if( $('#newbtnbox')[0] ){
                        $('#newbtnbox').remove();
                        $('#g-bd').prepend('<section class="m-recaddr" id="onlyAddress"></section><input type="hidden" id="address_id" name="address_id" value="'+addressData.id+'"/>');
                        _this.setOnlyAddress(addressData);
                    }else{
                        _this.setOnlyAddress(addressData);
                    }

                }
            }else{
                $('#onlyAddress,#address_id').remove();
                $('#g-bd').prepend('<section id=newbtnbox class=m-newbtnbox><span id=w-newbtn class=w-newbtn><span class=u-icn14></span>新建收货地址</span></section>');

            }

        },
        goBack:function(){
            var _this=this;
            var $toptitle=$('#toptitle');
            var toptitle=$toptitle.html();
            switch (toptitle){
                case '确认订单':
                    history.back();
                    break;
                case '收货地址选择':
                    $toptitle.html('确认订单');
                    $('#address').addClass('f-dn');
                    $('#orderform').removeClass('f-dn');
                    _this.getThisAddress();
                    break;
                case '修改收货地址':
                    $toptitle.html('收货地址选择');
                    $('#addressList').show();
                    $('#newaddressbox').empty();
                    break;
                case '新建收货地址':
                    if(!_this.dataAddress){
                        $toptitle.html('确认订单');
                        $('#newaddressbox').empty().hide();
                        $('#address').addClass('f-dn');
                        $('#orderform').removeClass('f-dn');

                    }else{
                        $toptitle.html('收货地址选择');
                        $('#newaddressbox').empty();
                        $('#addressList').show();
                    }
                    break;
                default :
                    break;
            }

        },
        dataAddress:null,
        parseDataAddress:function(r){
            for(var i= 0,len= r.length;i<len;i++){
                r[i].index=i;
                r[i].isChecked=0;
                r[i].addressInfo=r[i].province+r[i].city+r[i].area+r[i].address;
                if($('#address_id')[0]){
                    if($('#address_id').val()==r[i].id){
                        r[i].isChecked=1
                    }
                }
            }
            return r;
        },
        getAddressList:function(){
            var _this=this;
            $.getJSON('/member/address_list.html',function(r){
                if(r.state==200){
                    $('#myAddressList').empty();
                    _this.dataAddress= r.addresses;
                    _this.dataAddress=_this.parseDataAddress(_this.dataAddress);
                    $('#templateAddList').tmpl(_this.dataAddress).appendTo('#myAddressList');
                    $('#address').removeClass('f-dn');
                    $('#orderform').addClass('f-dn');
                    $('#toptitle').html('收货地址选择');
                    $('#menu').hide();
                }
            });
        },
        bindEvent:function(){
            var _this=this;
            var $toptitle=$('#toptitle');
            $('#backbtnConf').on('click',function(){
                _this.goBack();
            });

            $('#myAddressList').on('click','.choseAddress',function(){
                if($(this)[0].checked==true){
                    var index=$(this).attr('data-index');
                    var addressData=_this.dataAddress[index];
                    _this.setOnlyAddress(addressData);
                    $('#address').addClass('f-dn');
                    $toptitle.html('确认订单');
                    $('#orderform').removeClass('f-dn');
                }

            });
            $('#g-bd').on('click','#w-newbtn',function(){
                $('#address').removeClass('f-dn');
                $('#addressList').hide();
                $('#newaddressbox').empty().show();
                var is_abroad;
                if($('#is_abroad').val()=='True'){
                    is_abroad='True';
                }else{
                    is_abroad='False';
                }
                $('#templateAddAddress').tmpl({isEdit:0,is_abroad:is_abroad}).appendTo('#newaddressbox');
                $('#orderform').addClass('f-dn');
                $toptitle.html('新建收货地址');
                ht.core.location.getLocation(0);
                //$.tmpl('templateDialog', data).appendTo('body');
            });
            $('.submitbtn').on('click',function(){
                if(!$('#oneaddress')[0]){
                    ht.core.popUp.show('请先填写收货地址');
                    return false;
                }
                if($('#is_abroad').val()=='True'){
                    if($('#oneaddress').attr('data-cardnum')==''){
                        ht.core.popUp.show('此保税仓需要填写收货人身份证号');
                        return false;
                    }
                }
                $('#orderSubmitForm')[0].submit();
            });
            $('#newbtn').on('click',function(){
                $('#addressList').hide();
                $('#newaddressbox').empty().show();
                var is_abroad;
                if($('#is_abroad').val()=='True'){
                    is_abroad='True';
                }else{
                    is_abroad='False';
                }
                $('#templateAddAddress').tmpl({isEdit:0,is_abroad:is_abroad}).appendTo('#newaddressbox');
                $toptitle.html('新建收货地址');
                ht.core.location.getLocation(0);
            });
            $('#myAddressList').on('click','.delete',function(){
                var $this=$(this);
                var $root=$this.closest('.addritm');
                var index=$('#myAddressList .addritm').index($root);
                var dataUremove = [
                    { _aniClass:'show',confirm: {text: "确定要删除该收货地址吗？",btns: [{text: "确定",action: "ok"}, {text: "取消",action: "close"}]}}
                ];
                ht.core.dialog.show(dataUremove);
                ht.core.dialog.yes(function(){
                    var param={
                        _xsrf:$('input[name=_xsrf]').val(),
                        address_id:$this.closest('.addritm').attr('data-id')
                    }
                    $.ajax({
                        url: '/member/address.html',
                        data:param,
                        type: 'DELETE',
                        success: function(r) {
                            r=JSON.parse(r);
                            if(r.state==200){
                                $this.closest('.addritm').remove();
                                _this.dataAddress.splice(index,1);
                                ht.core.dialog.hide();
                            }
                        }
                    });
                });
            }).on('click','.edit',function(){
                var $this=$(this);
                var $root=$this.closest('.addritm');
                var index=$('#myAddressList .addritm').index($root);

                $('#addressList').hide();
                $('#newaddressbox').empty().show();

                var r=_this.dataAddress[index];
                r.isEdit=1;
                r.is_abroad='True'
                if($('#is_abroad').val()=='True'){
                    r.is_abroad='True';
                }else{
                    r.is_abroad='False';
                }

                $('#templateAddAddress').tmpl(r).appendTo('#newaddressbox');
                ht.core.location.getLocation(1,function(){

                    var $province=$('#province .option[title='+r.province+']');
                    $province.attr('selected','selected');
                    var valProvince=$province.attr('value');

                    var param={
                        parent_id:valProvince,
                        query_type:'city'
                    }
                    ht.core.location.get(param,'zp-city',0,$('#city'),1,function(){
                        var $city=$('#city .option[title='+r.city+']');
                        $city.attr('selected','selected');
                        var valCity=$city.attr('value');
                        var param={
                            parent_id:valCity,
                            query_type:'area'
                        }
                        ht.core.location.get(param,'zp-area',0,$('#area'),1,function(){
                            var $area=$('#area .option[title='+r.area+']');
                            $area.attr('selected','selected');
                        });
                    });

                });
                $toptitle.html('修改收货地址');
            });
            ;
            $('#g-bd').on('click','#onlyAddress',function(){
                _this.getAddressList();
            });

            $('body').on('click','#m-savebtn',function(){

                var $name=$('#name');
                var $idNum=$('#idNum');
                var $mobile=$('#mobile');
                var $province=$('#province');
                var $city=$('#city');
                var $area=$('#area');
                var $yourAddress=$('#yourAddress');

                if($.trim($('#name').val())==''){
                    ht.core.popUp.show($name.attr('data-message'));
                    return;
                }
                if( !ht.core.regular.phone.test($mobile.val()) ){
                    ht.core.popUp.show($mobile.attr('data-message'));
                    return;
                }
                if($('#is_abroad').val()=='True'){
                    if(!ht.core.regular.idcard($idNum.val())){
                        ht.core.popUp.show($idNum.attr('data-message'));
                        return;
                    }
                }

                if($province.val()=='-1'){
                    ht.core.popUp.show($province.attr('data-message'));
                    return;
                }
                if($city.val()=='-1'){
                    ht.core.popUp.show($city.attr('data-message'));
                    return;
                }
                if($area.val()=='-1'){
                    ht.core.popUp.show($area.attr('data-message'));
                    return;
                }
                if($yourAddress.val().length<5){
                    ht.core.popUp.show($yourAddress.attr('data-message'));
                    return;
                }
                var param={
                    _xsrf:$('input[name=_xsrf]').val(),
                    name:$name.val(),
                    province:$province.val(),
                    city:$city.val(),
                    area:$area.val(),
                    address:$yourAddress.val(),
                    card_num:$idNum.val(),
                    phone:$mobile.val()
                }
                if($(this).attr('data-isEdit')==1){
                    param.address_id=$(this).attr('data-id');
                }
                var address_id=param.address_id;
                $.post('/member/address.html',param,function(r){
                    var r=JSON.parse(r);
                    if(r.state==200){
                        $toptitle.html('收货地址选择');
                        _this.getAddressList();
                        $('#newaddressbox').empty();
                        $('#addressList').show();

                    }
                });

            });
        }
    }
    $(function(){
        ht.confirm.init();
    })
})();