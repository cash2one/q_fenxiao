;!function(a){a.fly=function(b,c){var d={version:"1.0.0",autoPlay:!0,vertex_Rtop:20,speed:1.2,start:{},end:{},onEnd:a.noop},e=this,f=a(b);e.init=function(a){this.setOptions(a),!!this.settings.autoPlay&&this.play()},e.setOptions=function(b){this.settings=a.extend(!0,{},d,b);var c=this.settings,e=c.start,g=c.end;f.css({marginTop:"0px",marginLeft:"0px",position:"absolute"}).appendTo("body"),null!=g.width&&null!=g.height&&a.extend(!0,e,{width:f.width(),height:f.height()});var h=Math.min(e.top,g.top)-Math.abs(e.left-g.left)/3;h<c.vertex_Rtop&&(h=Math.min(c.vertex_Rtop,Math.min(e.top,g.top)));var i=Math.sqrt(Math.pow(e.top-g.top,2)+Math.pow(e.left-g.left,2)),j=Math.ceil(Math.min(Math.max(Math.log(i)/.05-75,30),100)/c.speed),k=e.top==h?0:-Math.sqrt((g.top-h)/(e.top-h)),l=(k*e.left-g.left)/(k-1),m=g.left==l?0:(g.top-h)/Math.pow(g.left-l,2);a.extend(!0,c,{count:-1,steps:j,vertex_left:l,vertex_top:h,curvature:m})},e.play=function(){this.move()},e.move=function(){var b=this.settings,c=b.start,d=b.count,e=b.steps,g=b.end,h=c.left+(g.left-c.left)*d/e,i=0==b.curvature?c.top+(g.top-c.top)*d/e:b.curvature*Math.pow(h-b.vertex_left,2)+b.vertex_top;if(null!=g.width&&null!=g.height){var j=e/2,k=g.width-(g.width-c.width)*Math.cos(j>d?0:(d-j)/(e-j)*Math.PI/2),l=g.height-(g.height-c.height)*Math.cos(j>d?0:(d-j)/(e-j)*Math.PI/2);f.css({width:k+"px",height:l+"px","font-size":Math.min(k,l)+"px"})}f.css({left:h+"px",top:i+"px"}),b.count++;var m=window.requestAnimationFrame(a.proxy(this.move,this));d==e&&(window.cancelAnimationFrame(m),b.onEnd.apply(this))},e.destory=function(){f.remove()},e.init(c)},a.fn.fly=function(b){return this.each(function(){void 0==a(this).data("fly")&&a(this).data("fly",new a.fly(this,b))})}}(jQuery);
ht.detail={
    init:function(){
        this.loadData();
        this.getTax();
        this.bindEvent();
    },
    //获取商品税率规则
    getTax:function(){
        var index=ht.detail.goodInfo.is_abroad=='True'?0:1;
        var taxObj=ht.core.ops.tax[index];
        this.maxPrice=taxObj.maxPrice;
        this.taxRate=taxObj.taxRate;
        this.payTax=taxObj.payTax;
    },
    tempBuyAmount:0,
    loadData:function(){
        ht.detail.goodInfo=window.__getGoodsInfo();
        var detailStr = __getGoodsDetail(),
            attrName = 'src',
            blankImg = 'http://cdn.qqqg.com/web/images/blank.gif',
            reg = /(<img [^>]*src=['"])([^'"]+[^>]*>)/gi;
        var seoLabel='全球抢购';
        detailStr = detailStr.replace(reg, '$1' + blankImg + '" class="j-lazy"' + 'data-width="@640w" alt="' + seoLabel +'"  data-src="$2');
        $('#js_goodsdetail').html(detailStr);
        var btnJson={
            lowStocks:ht.detail.goodInfo.lowStocks,
            cartCount:ht.detail.goodInfo.cart_count>99?'99+':ht.detail.goodInfo.cart_count
        }
        $('#templateBtns').tmpl(btnJson).appendTo('#m-buybar');
        var skuJson={
            main_pic:ht.detail.goodInfo.main_pic,
            title:ht.detail.goodInfo.title,
            price:ht.detail.goodInfo.price,
            stockTxt:this.goodInfo.lowStocks=='True'?'库存不足':'库存充足',
            stockTip:parseInt(ht.detail.goodInfo.min_limit_quantity,10)>1?'最少限购数量'+ht.detail.goodInfo.min_limit_quantity:'',
            tempBuyAmount:this.tempBuyAmount>this.goodInfo.min_limit_quantity?this.goodInfo.tempBuyAmount:this.goodInfo.min_limit_quantity
        }
        $('#templateSku').tmpl(skuJson).appendTo('#m-sku');

    },
    bindEvent:function(){
        _this=this;
        var $buyBar=$('#m-buybar');
        $buyBar.on('click','#buyNow',function(event){
            if($(this).hasClass('dis')){
                return;
            }
            var tempBuyAmount=$tempBuyAmountObj.val();
            tempBuyAmount=parseInt(tempBuyAmount,10);
            if($(this).html()=='确认购买'){
                $('#buyNowFm .fmItem_id').val(ht.detail.goodInfo.itemId);
                $('#buyNowFm .fmItem_tempBuyAmount').val(tempBuyAmount);
                $('#buyNowFm')[0].submit();
                return;
            }

            ht.detail.getPrice(tempBuyAmount);
            $('.m-sku-mask').addClass('show');
            $('.m-sku').addClass('show');
            $(this).addClass('show').addClass('btn-large').html('确认购买');
            $('#addCart').addClass('hide');


        }).on('click','#addCart',function(event){
            if($(this).hasClass('dis')){
                return;
            }
            if($(this).html()=='确认加入'){
                $('#popUp').show();
                _this.flyToCart($(this),event);
                setTimeout(function(){

                },1000);

                return;
            }
            $('.m-sku-mask').addClass('show');
            $('.m-sku').addClass('show');
            $('#buyNow').addClass('hide');
            $(this).html('确认加入').addClass('show').addClass('btn-large');
            $('#cart').removeClass('hide');
        });

        $('#m-sku').on('click','#topbar-back',function(){
            $('.m-sku-mask').removeClass('show');
            $('.m-sku').removeClass('show');
            $('#addCart').removeClass('hide').html('加入购物车').removeClass('flyNow');
            $('#buyNow').removeClass('btn-large').removeClass('hide').html('立即购买').removeClass('dis');
            $('#cart').removeClass('hide');
        });
        var tempBuyAmount=1;
        var $tempBuyAmountObj=$('#tempBuyAmountObj');
        var $minus=$('.minus');
        var $plus=$('.plus');
        $plus.on('click',function(){
            var tempBuyAmount=$tempBuyAmountObj.val();
            if(tempBuyAmount==ht.detail.goodInfo.max_limit_quantity){
                $(this).addClass('dis');
                $(this).children().addClass('u-icn14-2');
                return;
            }
            tempBuyAmount=parseInt(tempBuyAmount,10)+1;
            if(tempBuyAmount>1){
                $minus.removeClass('dis').children().removeClass('u-icn14-3');
            }else {
                $minus.addClass('dis').children().addClass('u-icn14-3');
            }
            if(ht.detail.goodInfo.is_abroad=='True'){
                if(ht.detail.goodInfo.price*tempBuyAmount>ht.detail.maxPrice){
                    $(this).addClass('dis');
                    $(this).children().addClass('u-icn14-2');
                }
                ht.detail.getPrice(tempBuyAmount);
            }


            $tempBuyAmountObj.val(tempBuyAmount);
        });
        $minus.on('click',function(){
            if($(this).hasClass('dis')){
                return false;
            }
            var tempBuyAmount=$tempBuyAmountObj.val();
            if(tempBuyAmount==ht.detail.goodInfo.min_limit_quantity){
                $(this).addClass('dis');
                return false;
            }
            tempBuyAmount=parseInt(tempBuyAmount,10)-1;
            if(tempBuyAmount==1){
                $minus.addClass('dis').children().addClass('u-icn14-3');
            }else{
                $minus.removeClass('dis').children().removeClass('u-icn14-3');
            }
            $plus.removeClass('dis');
            $plus.children().removeClass('u-icn14-2');
            if(ht.detail.goodInfo.is_abroad=='True'){
                ht.detail.getPrice(tempBuyAmount);
            }
            $tempBuyAmountObj.val(tempBuyAmount);
        });

        $('#u-slide-detail').on('click',function(){
            var top=$('#js_goodsdetail').offset().top;
            $('body,html').animate({scrollTop:top},1000);
        });

    },
    flyToCart:function($this,event){
        if($(this).hasClass('dis')){
            return false;
        }
        var addcar = $this;
        var offset = $("#cart").offset();
        var img = $('#showImg').attr('src');
        var flyer = $('<img class="u-flyer" src="'+img+'">');
        flyer.fly({
            start: {
                left: $('#showImg').offset().left,//event.pageX,
                top: $('#showImg').offset().top //event.pageY
            },
            end: {
                left: offset.left+10,
                top: offset.top+10,
                width: 0,
                height: 0
            },
            onEnd: function(){

                 var param={
                 item_id:ht.detail.goodInfo.itemId,
                 item_num:$('#tempBuyAmountObj').val()
                 }
                 $.getJSON('/member/addcart',param,function(r){
                     if(r.state==200){
                         var cartCount= r.account;
                         cartCount=cartCount>99?'99+':cartCount;
                         $('#cart .count').text(cartCount);
                     }
                     $('#popUp').hide();
                     $('#topbar-back').click();
                 });


                this.destory();
            }
        });

    },
    getPrice:function(n){
        var $overAmount=$('#overAmount');
        if(ht.detail.payTax==0){
            $overAmount.removeClass('show');
            return;
        }
        if(ht.detail.goodInfo.price*n>ht.detail.maxPrice){
            $overAmount.addClass('show');
            $('#buyNow,#addCart').addClass('dis');
        }
        else{
            $overAmount.removeClass('show');
            $('#buyNow,#addCart').removeClass('dis');
        }
    }
}
$(function(){
    ht.detail.init();
});

