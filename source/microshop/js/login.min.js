ht.login={
    init:function(){
        this.bindEvent();
    },
    popUp:function(s){
        var $popUp=$('#popUp');
        $popUp.find('.box').html(s);
        $popUp.show();
        setTimeout(function(){$('#popUp').hide();
        },1000);
    },
    validate:{
        chkPhone:function($obj){
            var _this=ht.login;
            var isOk=true;
            if($.trim($obj.val())==''){
                _this.popUp('请填写电话号码');
                isOk=false;
            }else if (!/^1\d{10}$/.test($obj.val())){
                _this.popUp('手机号码格式不正确');
                isOk=false;
            }
            return isOk;
        }
    },
    getNext:function(){
        var next=ht.core.getQuery('next');
        var nexturl='';
        if(window.location.href.indexOf('/app/')>-1){
            nexturl='/app/index.html';
        }
        else{
            nexturl=next?next:'/';
        }
        return nexturl;
    },
    bindEvent:function(){
        var _this=this;
        var $u=$('#username'),$ndel=$('#namedel'),$pwd=$('#password');
        $('#username').on('keyup',function(){
           if($(this).val()!=''){
               $ndel.show();
           }
        });
        $ndel.on('click',function(){
            $u.val('');
            $(this).hide();
        });
        var $smsphone=$('#smsphone'),$phonedel=$('#phonedel');
        $smsphone.on('keyup',function(){
            if($(this).val()!=''){
                $phonedel.show();
            }
        });
        $phonedel.on('click',function(){
            $smsphone.val('');
            $(this).hide();
        });
        $('#submit').on('click',function(){
            var isPhone=ht.login.validate.chkPhone($u);
            if(!isPhone){
                return false;
            }
            if($pwd.val()==''){
                _this.popUp('请填写密码');
                return false;
            }
            if($.trim($u.val())!='' && $pwd.val()!=''){
                var param={
                    login_type:'usename',
                    usename: $u.val(),
                    password :$pwd.val(),
                    _xsrf:$('input[name=_xsrf]').val()
                }
                $.post('/login.html',param,function(r){
                    var r=JSON.parse(r);
                    if(r.state!=200){
                        _this.popUp('密码不正确');
                        return false;
                    }else{
                        window.location.href= ht.login.getNext();
                    }
                });
            }
        });
        $('#switchSms').on('click',function(){
            if($(this).html()=='短信快捷登录'){
                $(this).html('手机号码登录');
                $('#smsloginform').show();
                $('#loginform').hide();
            }else{
                $(this).html('短信快捷登录');
                $('#smsloginform').hide();
                $('#loginform').show();
            }
        });

        $('#getKeyWord').on('click',function(){
            var $smsphone=$('#smsphone');
            var isSmsphone=ht.login.validate.chkPhone($smsphone);
            if(!isSmsphone){
                return false;
            }
            if($(this).hasClass('btn_enabled')) {
                return false;
            }
            var param={
                phone:$smsphone.val()
            }
            var timeline=60;
            var $this=$(this);
            $this.html('重新获取('+timeline+')').attr('v',timeline).addClass("btn_enabled");
            $.get('/common/phone/code/',param,function(){
                ht.core.setCountDown($this,'获取动态密码');
            });
        });


        $('#smsSubmit').click(function(){
            var $smsphone=$('#smsphone');
            var $smskeyword=$('#smskeyword');
            var isSmsphone=ht.login.validate.chkPhone($smsphone);
            var isSmskeyword=$smskeyword.val()!=''?true:false;
            !isSmskeyword && _this.popUp('请输入动态密码');
            if(isSmsphone&&isSmskeyword){
                var param={
                    login_type:'phone',
                    phone: $smsphone.val(),
                    code  :$smskeyword.val(),
                    _xsrf:$('input[name=_xsrf]').val()
                }
                $.post('/login.html',param,function(r){
                    var r=JSON.parse(r);
                    if(r.state!=200){
                        _this.popUp(r.info);
                        return false;
                    }else{
                        window.location.href= ht.login.getNext();
                    }
                });
            }
        });
    }
}
$(function(){
    ht.login.init();
});