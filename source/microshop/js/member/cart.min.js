;;(function(){
    ht.cart={
        init:function(){
            ht.core.dialog.init();
            this.getEmptyTemp();
            this.getData();
            this.bindEvent();
        },
        //获取税率规则
        getTaxByWarehouse:function(is_abroad){
            var index=is_abroad=='True'?0:1;
            var taxObj=ht.core.ops.tax[index];
            return taxObj;
        },
        oriData:{},
        getEmptyTemp:function(){
            var myTemplate='<section class="m-emtpy f-tac"><span class="u-icn5"></span><p class="tiptxt">购物车里空空如也，赶紧去逛逛吧！</p><a class="u-btn" href="/">去逛逛</a></section>';
            if($('#appfootmenu')[0]){
                myTemplate='<section class="m-emtpy f-tac"><span class="u-icn5"></span><p class="tiptxt">购物车里空空如也，赶紧去逛逛吧！</p><a class="u-btn" href="/app/index.html">去逛逛</a></section>';
            }
            $.template('templateEmpty', myTemplate);
        },
        parseData:function(data){
            data.price=0;
            data.good_counts=data.items.length;
            data.total_price=0;
            data.moneyCount=0;
            data.goods=data.items;
            for(var i= 0,len=data.items.length;i<len;i++){
                data.total_price=data.total_price+data.items[i].price*data.items[i].amount;
                data.items[i].main_pic=(data.items[i].main_pic.indexOf(';')>-1?data.items[i].main_pic.split(';')[0]:data.items[i].main_pic);
                data.items[i].pIndex=i;
            }
            data.moneyCount=data.total_price;
            /*
            for(var i= 0,len=data.length;i<len;i++){
                data[i].price=0;
                data[i].goods=data[i].items;
                data[i].orderIndex=i;
                data[i].is_abroad='False';
                for(var m= 0,lenM=data[i].items.length;m<lenM;m++){
                    data[i].items[m].oIndex=i;
                    data[i].items[m].pIndex=m;
                    data[i].price=data[i].price+data[i].items[m].price;
                    data[i].items[m].main_pic=(data[i].items[m].main_pic.indexOf(';')>-1?data[i].items[m].main_pic.split(';')[0]:data[i].items[m].main_pic);
                    data[i].items[m].is_abroad=data[i].is_abroad;

                }
                data[i].paidPrice=data[i].price;
                if(data[i].is_abroad=='True'){
                    data[i].moneyCount=data[i].total_price+(data[i].tax_acount<=ht.core.ops.tax[0].taxRate?0:data[i].tax_acount);
                    data[i].isOver=(data[i].good_counts>1 && data[i].moneyCount>ht.core.ops.tax[0].maxPrice)?1:0;
                }else{
                    data[i].tax_acount=0;
                    data[i].moneyCount=data[i].total_price;
                    data[i].isOver=0;
                }

            }
            */
            return data;
        },
        getData:function(){
            var _this=this;
            $('#carts').empty();
            var param={
                _xsrf:$('input[name=_xsrf]').val()
            }
            $.ajax({
                url: '/member/cart.html',
                data:param,
                type: 'PUT',
                success: function(r) {
                    r=JSON.parse(r);
                    if(r.state==200){
                        var orderJson= r.items;

                        $('#cartCount').html('('+ r.total_count+')');
                        orderJson=_this.parseData(r);
                        _this.oriData=orderJson;
                        if(orderJson.total_count==0){
                            $.tmpl('templateEmpty', {}).appendTo('#carts');
                        }else{
                            $('#templateOrder').tmpl(orderJson).appendTo('#carts');
                        }
                    }
                }
            });
        },
        changeProductNum:function(){
            var param={
                item_id:ht.detail.goodInfo.itemId,
                item_num:$('#tempBuyAmountObj').val()
            }
            $.getJSON('/member/addcart',param,function(r){
                if(r.state==200){
                    var cartCount= r.account;
                    cartCount=cartCount>99?'99+':cartCount;
                    $('#cart .count').text(cartCount);
                }
                $('#popUp').hide();
                $('#topbar-back').click();
            });
        },
        getGoodObj:function($root){
            var pIndex=parseInt($root.attr('data-pIndex'),10);
            var goodsObj={
                orderO:this.oriData,
                goods:this.oriData.items[pIndex],
                goodsO:this.oriData.items,
                pIndex:pIndex
            }
            return goodsObj;
        },
        getHouseObj:function($rootMcart){
            var oIndex=parseInt($rootMcart.attr('data-oIndex'),10);
            var ordersObj={
                orderO:this.oriData,
                ordersObj:this.oriData[oIndex]
            }
            return ordersObj;
        },
        changeCount:function($this,_val){
            var _this=this;
            var $root=$this.closest('.gitm');
            var $rootOrder=$this.closest('.m-cart');
            var goodObj=_this.getGoodObj($root).goods;
            var param={
                _xsrf:$('input[name=_xsrf]').val(),
                item_id:goodObj.id,
                item_num:_val
            }
            $.ajax({
                url: '/member/addcart',
                data:param,
                type: 'PUT',
                success: function(r) {
                    r=JSON.parse(r);
                    if(r.state==200){
                        _this.setChosenNum($rootOrder);
                        _this.getALLPrice($rootOrder);
                        _this.getCountNum();
                    }
                }
            });
        },
        getALLPrice:function($rootOrder){
            var _this=this;
            var totalPrice=0;
            var goodObj,num;
            var tariffVal=0;
            $rootOrder.find('.chosen').each(function(){
                goodObj=_this.getGoodObj($(this));
                num=$(this).find('.buyNum').val();
                totalPrice=parseFloat(totalPrice)+parseFloat(parseInt(num,10)*goodObj.goods.price);
                var tax_rate=goodObj.goods.tax_rate;
                tariffVal=0;

            });

            totalPrice=totalPrice.toFixed(2);
            tariffVal=tariffVal.toFixed(2);
            var tariff=0;
            tariff=0;
            $rootOrder.find('.tariffLbl').addClass('del');
            $rootOrder.find('.tariff').text(tariffVal);
            $rootOrder.find('.total_price').text(totalPrice);
            var tariffVal=0;
            var moneyCount=parseFloat(totalPrice)+tariff;
            $rootOrder.find('.moneyCount').text(moneyCount);
            var finalChooseNum=parseFloat($rootOrder.find('.finalChooseNum').text());

            if(finalChooseNum==0){
                $rootOrder.find('.settlementBtn').addClass('u-btn-disab');

            }else{
                $rootOrder.find('.settlementBtn').removeClass('u-btn-disab');
            }



        },
        setChosenNum:function($rootOrder){
            var buyNum=0;
            $rootOrder.find('.chosen .buyNum').each(function(){
                buyNum=buyNum+parseInt($(this).val(),10);
            });
            var finalChooseNum=buyNum;
            $rootOrder.find('.finalChooseNum').text(finalChooseNum);
        },
        getCountNum:function(){
            var n=0;
            $('.buyNum').each(function(){
                n=n+parseInt($(this).val(),10);
            });
            $('#cartCount').html('('+n+')');
        },
        bindEvent:function(){
            var _this=this;

            $('#carts').on('click','.checkAll',function(){
                var $rootOrder=$(this).closest('.m-cart');
                if($(this)[0].checked==true){
                    $rootOrder.find('.m-cartgoods').find('input[type=checkbox]').each(function(){
                        $(this)[0].checked='checked';
                        var $parent=$(this).closest('.gitm');
                        //$parent.find('.buyNum').attr('name','tempBuyAmount');
                        $parent.addClass('chosen');
                    });
                }else{
                    $rootOrder.find('.m-cartgoods').find('input[type=checkbox]').each(function(){
                        $(this)[0].checked='';
                        $(this).siblings('input[name=item_id]').remove();
                        var $parent=$(this).closest('.gitm');
                        //$parent.find('.buyNum').attr('name','tempBuyAmountNull');
                        $parent.removeClass('chosen');
                    });
                }
                _this.setChosenNum($rootOrder);
                _this.getALLPrice($rootOrder);
            }).on('click','.checkone',function(){
                var $rootOrder=$(this).closest('.m-cart');
                var $gitm=$(this).closest('.gitm');
                var goodObj=_this.getGoodObj($gitm);
                if($(this)[0].checked==true){
                    if(!$(this).siblings('input[name=item_id]')[0]){
                        var item_id=goodObj.goods.id;
                        $(this).before('<input type="hidden" name="item_id" value="'+item_id+'">');
                    }
                    //$gitm.find('.buyNum').attr('name','tempBuyAmount');
                    $gitm.addClass('chosen');
                }else{
                    $gitm.removeClass('chosen');
                    //$gitm.find('.buyNum').attr('name','tempBuyAmountNull');
                    $(this).siblings('input[name=item_id]').remove();
                }
                _this.setChosenNum($rootOrder);
                _this.getALLPrice($rootOrder);
            });

            var dataUremove = [
                { _aniClass:'show',confirm: {text: "确定删除该商品吗？",btns: [{text: "确定",action: "ok"}, {text: "取消",action: "close"}]}}
            ];
            $('#carts').on('click','.u-remove',function(){
                var $this=$(this);
                var $rootOrder=$(this).closest('.m-cart');
                var $goodli=$this.closest('.gitm');
                ht.core.dialog.show(dataUremove);
                var goodObj=_this.getGoodObj($goodli);

                $('body').on('click','#m-dialog .ok',function(){
                    var param={
                        _xsrf:$('input[name=_xsrf]').val(),
                        item_id:goodObj.goods.id
                    }
                    $.ajax({
                        url: '/member/cart.html',
                        data:param,
                        type: 'DELETE',
                        success: function(r) {
                            r=JSON.parse(r);
                            if(r.state==200){
                                $('#m-dialog').remove();
                                if(goodObj.goodsO.length==1){
                                    $goodli.closest('.m-cart').remove();
                                }
                                $goodli.remove();
                                if($('#carts .m-cart').length==0){
                                    $.tmpl('templateEmpty', {}).appendTo('#carts');
                                    $('#cartCount').html('(0)');
                                }else{
                                    _this.setChosenNum($rootOrder);
                                    _this.getALLPrice($rootOrder);
                                }
                                _this.getCountNum();
                            }
                        }
                    });
                });
            });

            $('#carts').on('click','.settlementBtn',function(){
                if($(this).hasClass('u-btn-disab')){
                    return;
                }
                $(this).closest('form')[0].submit();
            });
            var timer;
            $('#carts').on('click','.plus',function(){
                var $this=$(this);
                var $root=$(this).closest('.gitm');
                var goodObj=_this.getGoodObj($root).goods;
                var min=goodObj.min_limit_quantity;
                var max=goodObj.max_limit_quantity;
                var $buyNum=$(this).siblings('.buyNum');
                var _val=$buyNum.val();
                if(_val==max){return false}
                $buyNum.val(parseInt(_val,10)+1);
                $buyNum.val()>min && $(this).siblings('.minus').removeClass('z-dis');
                $buyNum.val()==max && $(this).addClass('z-dis');
                clearTimeout(timer);
                var _val=$buyNum.val();
                $root.find('.goodAmount').text(_val);
                timer=setTimeout(function(){
                    _this.changeCount($this,_val);
                },500);
            }).on('click','.minus',function(){
                var $this=$(this);
                var $root=$(this).closest('.gitm');
                var goodObj=_this.getGoodObj($root).goods;
                var min=goodObj.min_limit_quantity;
                var max=goodObj.max_limit_quantity;
                var $buyNum=$(this).siblings('.buyNum');
                var _val=$buyNum.val();
                if( $(this).hasClass('z-dis') ){return}
                $buyNum.val(parseInt(_val,10)-1);
                _val=$buyNum.val();
                _val==min && $(this).addClass('z-dis');
                _val<max && $(this).siblings('.plus').removeClass('z-dis');
                $root.find('.goodAmount').text(_val);
                clearTimeout(timer);
                timer=setTimeout(function(){
                    _this.changeCount($this,_val);
                },500);
            });


        }
    }
    $(function(){
        ht.cart.init();
    });
})();