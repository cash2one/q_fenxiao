(function( window, undefined ) {
    ht.order={
        init:function(){
            $('#cart')[0] && this.cart.init();//购物车页面
            $('#orders')[0] && this.orders.init();//订单页面
            $('#payway')[0] && this.payway.init();//支付页面
            $('#orderdetail')[0] && this.orderdetail.init();//支付页面
        },
        cart:{
            init:function(){
                //$('.trHeight').after($('.trHeight').prop("outerHTML"));


                this.calculationTariff();
                $('.askIcon').mouseover(function(){
                    $(this).next('.tip-wrap').show();
                });
                $('.tip-wrap').mouseout(function(){
                    $(this).hide();
                });

                $('.trHeight .checkboxIcons').click(function(){
                    var $tr=$(this).closest('tr.trHeight');
                    var $productTable=$(this).closest('.productTable');
                    if(!$(this).hasClass('checkboxSimulateChecked')){
                        if(!$(this).siblings('input[name=item_id]')[0]){
                            var item_id=$(this).attr('data-itemid');
                            $(this).before('<input type="hidden" name="item_id" value="'+item_id+'">');
                        }
                        $(this).addClass('checkboxSimulateChecked');
                        $tr.addClass('chosen');
                    }else{
                        $(this).removeClass('checkboxSimulateChecked');
                        $tr.removeClass('chosen');
                        $(this).siblings('input[name=item_id]').remove();
                    }
                    var $productTable=$(this).closest('.productTable');
                    var buyNum=0;
                    $productTable.find('.chosen .buyNum').each(function(){
                        buyNum=buyNum+parseInt($(this).val(),10);
                    });
                    var finalChooseNum=buyNum;
                    $productTable.find('.finalChooseNum').text(finalChooseNum);
                    ht.order.cart.getALLPrice($productTable);
                    if($('.trHeight .checkboxSimulateChecked').length==$('.trHeight .checkboxIcons').length){
                        $productTable.find('.checkAll').addClass('checkboxSimulateChecked');

                    }else{
                        $productTable.find('.checkAll').removeClass('checkboxSimulateChecked');
                    }


                });
                $('.checkAll').click(function(){
                    var $productTable=$(this).closest('.productTable');
                    if(!$(this).hasClass('checkboxSimulateChecked')){
                        $productTable.find('.checkboxIcons').addClass('checkboxSimulateChecked');
                        $productTable.find('.submitCartBtn').removeClass('oOrgBtnDis');
                        $productTable.find('.ordersub').removeClass('dis');
                        $productTable.find('.goToChoice').hide();
                        $productTable.find('.trHeight').addClass('chosen');
                        $productTable.find('.checkboxIcons').each(function(){
                            if(!$(this).siblings('input[name=item_id]')[0]){
                                var item_id=$(this).attr('data-itemid');
                                $(this).before('<input type="hidden" name="item_id" value="'+item_id+'">');
                            }
                        });

                        $productTable.find('input[name=item_id]')

                    }else{
                        $productTable.find('.checkboxIcons').removeClass('checkboxSimulateChecked');
                        $productTable.find('.submitCartBtn').addClass('oOrgBtnDis');
                        $productTable.find('.ordersub').addClass('dis');
                        $productTable.find('.goToChoice').show();
                        $productTable.find('.trHeight').removeClass('chosen');
                        $productTable.find('input[name=item_id]').remove();
                    }

                    var buyNum=0;
                    $productTable.find('.chosen .buyNum').each(function(){
                        buyNum=buyNum+parseInt($(this).val(),10);
                    });
                    var finalChooseNum=buyNum;
                    $productTable.find('.finalChooseNum').text(finalChooseNum);
                    ht.order.cart.getALLPrice($productTable);
                });

                $('.submitCartBtn').click(function(){
                    if(!$(this).hasClass('oOrgBtnDis')){
                        $(this).closest('form')[0].submit();
                    }
                });

                $('.buyNum').each(function(){
                    var minCount=parseInt($(this).attr('min_count'),10);
                    var maxCount=parseInt($(this).attr('max_Count'),10);
                    var $addNum=$(this).siblings('.addNum');
                    var $reduceNum=$(this).siblings('.reduceNum');
                    if($(this).val()==minCount){
                        $reduceNum.addClass('ctrNumDis');
                    }
                    if($(this).val()==maxCount){
                        $addNum.addClass('ctrNumDis');
                    }
                });

/*
                $('.buyNum').keyup(function(){
                    if($(this).val().length==1){
                        var v=$(this).val().replace(/[^1-9]/g,'');
                        var val=v==''?1:v;
                        $(this).val(val);
                    }else{
                        var v=$(this).val().replace(/\D/g,'');
                        var val=v==''?1:v;
                        $(this).val(val);
                    }
                });
*/


                var timer;
                $('.buyBox .addNum').click(function(){
                    var $this=$(this);
                    var $buyNum=$(this).siblings('.buyNum');
                    var minCount=parseInt($buyNum.attr('min_count'),10);
                    var maxCount=parseInt($buyNum.attr('max_Count'),10);
                    var _val=$buyNum.val();
                    if(_val==maxCount){return false}
                    $buyNum.val(parseInt(_val,10)+1);
                    $buyNum.val()>minCount && $this.siblings('.reduceNum ').removeClass('ctrNumDis');
                    $buyNum.val()==maxCount && $(this).addClass('ctrNumDis');
                    clearTimeout(timer);
                    var _val=$buyNum.val();
                    timer=setTimeout(function(){
                        ht.order.cart.changeCount($this,_val);
                    },500);
                });
                $('.buyBox .reduceNum').click(function(){
                    var $this=$(this);
                    var $buyNum=$(this).siblings('.buyNum');
                    var minCount=parseInt($buyNum.attr('min_count'),10);
                    var maxCount=parseInt($buyNum.attr('max_Count'),10);
                    if( $buyNum.val()<=minCount ){return}
                    if( $(this).hasClass('ctrNumDis') ){return}
                    $buyNum.val(parseInt($buyNum.val(),10)-1);
                    $buyNum.val()==minCount && $(this).addClass('ctrNumDis');
                    $buyNum.val()<maxCount && $(this).siblings('.addNum').removeClass('ctrNumDis');

                    clearTimeout(timer);
                    var _val=$buyNum.val();
                    timer=setTimeout(function(){
                        ht.order.cart.changeCount($this,_val);
                    },500);

                });

                $('.buyNum').keyup(function(){
                    var $minus=$(this).siblings('.reduceNum');
                    var $plus=$(this).siblings('.addNum');
                    var minCount=parseInt($(this).attr('min_count'),10);
                    var maxCount=parseInt($(this).attr('max_Count'),10);
                    if($(this).val().length==1){
                        var v=$(this).val().replace(/[^1-9]/g,'');
                        var val=(v==''||v<minCount)?minCount:v;
                        $(this).val(val);
                    }else{
                        var v=$(this).val().replace(/\D/g,'');
                        var val=(v==''||v<minCount)?minCount:v;
                        val=v>maxCount?maxCount:v;
                        $(this).val(val);
                    }
                    if($(this).val()>minCount){
                        $minus.removeClass('ctrNumDis');
                    }else{
                        $minus.addClass('ctrNumDis');
                    }
                    if($(this).val()>=maxCount){
                        $plus.addClass('ctrNumDis');
                    }else{
                        $plus.removeClass('ctrNumDis');
                    }
                }).blur(function(){
                    var $this=$(this);
                    var _val=$this.val();
                    ht.order.cart.changeCount($this,_val);
                });
                this.bindEvent();
            },
            //计算关税
            calculationTariff:function(){
                $('.productTable').each(function(){
                    if( $(this).attr('is_abroad')=='False' ){
                        return false;
                    }
                    var finalChooseNum=parseInt($(this).find('.finalChooseNum').text(),10);
                    var totalPrice=parseInt($(this).find('.totalPrice').text(),10);
                    if(finalChooseNum>1 && totalPrice> ht.util.ops.tax[0].maxPrice ){
                        $(this).find('.goToPayNotice').show();
                        $(this).find('.submitCartBtn').addClass('oOrgBtnDis');
                        $(this).find('.ordersub').addClass('dis');
                    }
                });
            },
            getALLPrice:function($productItem){
                var totalPrice=0;
                $productItem.find('.chosen .amountMoney').each(function(){
                    totalPrice=parseFloat(totalPrice)+parseFloat($(this).text());
                });
                totalPrice=totalPrice.toFixed(2);
                $productItem.find('.totalPrice').text(totalPrice);
                var moneyCount=0;
                var discount=parseFloat($productItem.find('.discount').text());
                var tariffVal=0;
                $productItem.find('.chosen .buyNum').each(function(){
                    var tax_rate=parseInt($(this).attr('tax_rate'),10);
                    if($productItem.attr('is_abroad')=='False'){
                        tariffVal=0;
                        tax_rate=0;
                    }
                    if(tax_rate!=0){
                        tariffVal=tariffVal+parseFloat($(this).val())*parseFloat($(this).attr('price'))*tax_rate/100;
                    }
                });
                tariffVal=tariffVal.toFixed(2);
                $productItem.find('.tariff').text(tariffVal);
                var tariff=0;
                if(parseFloat(tariffVal)<=ht.util.ops.tax[0].taxRate){
                    tariff=0;
                    $productItem.find('.tariffLbl').addClass('lineThrough');
                }else{
                    tariff=parseFloat(tariffVal);
                    $productItem.find('.tariffLbl').removeClass('lineThrough');
                }
                moneyCount=parseFloat(totalPrice)-discount+tariff;
                moneyCount=moneyCount>0?moneyCount:0;
                moneyCount=moneyCount.toFixed(2);
                $productItem.find('.moneyCount').text(moneyCount);
                var finalChooseNum=parseFloat($productItem.find('.finalChooseNum').text());
                var isMaxPrice=true;
                if($productItem.attr('is_abroad')=='True'){
                    isMaxPrice=totalPrice>ht.util.ops.tax[0].maxPrice;
                }
                if(isMaxPrice && finalChooseNum>1){
                    $productItem.find('.submitCartBtn').addClass('oOrgBtnDis');
                    $productItem.find('.ordersub').addClass('dis');
                    $productItem.find('.goToPayNotice').show();
                }else{
                    $productItem.find('.submitCartBtn').removeClass('oOrgBtnDis');
                    $productItem.find('.ordersub').removeClass('dis');
                    $productItem.find('.goToPayNotice').hide();
                }

                if($productItem.find('.trHeight .checkboxSimulateChecked').length==0){
                    $productItem.find('.submitCartBtn').addClass('oOrgBtnDis');
                    $productItem.find('.ordersub').addClass('dis');
                    $productItem.find('.goToChoice').show();
                }else{
                    if($productItem.attr('is_abroad')=='False'){
                        $productItem.find('.submitCartBtn').removeClass('oOrgBtnDis');
                        $productItem.find('.ordersub').removeClass('dis');
                    }

                    $productItem.find('.goToChoice').hide();
                }
            },
            changeCount:function($this,_val){
                var $tr=$this.closest('tr.trHeight');
                var $productTable=$this.closest('.productTable');
                var param={
                    _xsrf:$('input[name=_xsrf]').val(),
                    item_id:$tr.attr('data-id'),
                    item_num:_val
                }
                $.ajax({
                    url: '/order/cart.html',
                    data:param,
                    type: 'PUT',
                    success: function(r) {
                        r=JSON.parse(r);
                        if(r.state==200){
                            var amountMoney=_val*$tr.find('.price').text();
                            $tr.find('.amountMoney .strongSize').text(amountMoney);
                            ht.order.cart.setChosenNum($productTable);
                            ht.order.cart.getALLPrice($productTable);
                        }
                    }
                });
            },
            setChosenNum:function($productTable){
                var buyNum=0;
                $productTable.find('.chosen .buyNum').each(function(){
                    buyNum=buyNum+parseInt($(this).val(),10);
                });
                var finalChooseNum=buyNum;
                $productTable.find('.finalChooseNum').text(finalChooseNum);
            },
            bindEvent:function(){

                $('#cart').on('click','.cartShutBtn',function(){
                    var $this=$(this);
                    var $productTable=$this.closest('.productTable');
                    var $tr=$this.closest('tr.trHeight');
                    ht.util.popAlert.run(function(){
                        var str=ht.util.popAlert.confirm('您确定要删除吗？','iDialogDelCart')
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#iDialogDelCart .iDialogYes').click(function(){
                            var param={
                                _xsrf:$('input[name=_xsrf]').val(),
                                item_id:$tr.attr('data-id')
                            }
                            $.ajax({
                                url: '/order/cart.html',
                                data:param,
                                type: 'DELETE',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $tr.remove();
                                        if($('.productTable .trHeight').length==0){
                                            $('#productEmpty').show();
                                            $('form[name=fmCart]').remove();

                                        }else{
                                            ht.order.cart.setChosenNum($productTable);
                                            ht.order.cart.getALLPrice($productTable);
                                        }
                                    }
                                }
                            });
                            $.unblockUI();
                        });
                    });
                });

            }
        },
        orders:{
            init:function(){
                ht.util.location.init();
                if($('#is_abroad').val()=='False'){
                    $('.item-idcard').remove()
                }
                $('.m-checkbox').click(function(){
                    if($(this).hasClass('m-checked')){
                        $(this).removeClass('m-checked');
                    }else{
                        $(this).addClass('m-checked');
                    }

                });
                if($('#user-addresses .addresses').size()==0){
                    $('#addNewAd').show();
                }else{
                    $('#addNewAd').hide();
                }
                this.bindEvent();
            },
            setProCityArea:function(){
                var $result=$('#provicecityarea .result');
                $('#province').val($result.eq(0).attr('value')).attr('data-title',$result.eq(0).html());
                $('#city').val($result.eq(1).attr('value')).attr('data-title',$result.eq(1).html());
                $('#area').val($result.eq(2).attr('value')).attr('data-title',$result.eq(2).html());

            },
            bindEvent:function(){
                var _this=this;
                $("#addressfm").Validform({
                    btnSubmit:"#addressSubmit",
                    btnReset:"",
                    tiptype:3,
                    ignoreHidden:false,
                    ajaxPost:true,
                    datatype:ht.util.validformParam.datatype,
                    beforeCheck:function(curform){
                        //common.CheckPictureType(fileName)
                        //_this.setProCityArea();
                    },
                    beforeSubmit:function(curform){
                        _this.setProCityArea();

                    },
                    ajaxpost:{
                        error:function(data,obj){
                        }
                    },
                    callback:function(data){
                        if(data.status=="y"){
                            setTimeout(function(){$.Hidemsg();},1000);
                            var addressdetail=$('#province').attr('data-title')+$('#city').attr('data-title')+$('#area').attr('data-title')+$('#address').val();
                            var resultAdd = [
                                {
                                    name:$('#name').val(),
                                    addressdetail:addressdetail,
                                    phone:$('#phone').val(),
                                    addressid:data.addressId,
                                    addressCheck:$('#addressSubmit').attr('data-check')
                                }
                            ];

                            if(!$("#addressfm input[name=address_id]")[0]){
                                $('#user-addresses .adrLabel').removeClass('addressCheck');
                                $('#address-header').after($('#templateaddress').tmpl(resultAdd));
                                $('#user-addresses .adrLabel:first').addClass('addressCheck');
                            }
                            else{
                                var aId=$("#addressfm input[name=address_id]").val();
                                var objAdd=$('#user-addresses .addresses[data-id='+aId+']')
;                                objAdd.empty();
                                $('#templateAddressesIn').tmpl(resultAdd).appendTo(objAdd);
                            }

                            $('#addNewAd').hide();
                            $("html,body").animate({scrollTop:$("#user-addresses").offset().top},200);
                        }else{
                            $.Showmsg(data.info);
                            return false;
                        }
                    }

                });
                $('#addNewAd .closeIcon').click(function(){
                    $('#addNewAd').hide();
                });
                $('#font_card,#back_card').change(function(){
                    $(this).parent().next('.filesTxt').html($(this).val());;
                });
                $('#user-addresses').on('click','.addresses',function(){
                    $('.adrLabel').removeClass('addressCheck');
                    $(this).find('.adrLabel').addClass('addressCheck');
                    $('#font_card,#back_card').val('');
                    $('#idCardPhotos .filesTxt').html('');
                    if($(this).attr('data-card-img')=='True'){
                        $('#idCardPhotos').hide();
                    }
                });

                $('#user-addresses').on('click','.setDefault',function(){
                    var param={
                        address_id:$(this).closest('.addresses').attr('data-id')
                    };
                    var $this=$(this);
                    $.get('/member/address.html',param,function(r){
                        r=JSON.parse(r);
                        if(r.state==200){
                            if(!$this.next('.default')[0]){

                                $('#user-addresses .default').after('<a href="javascript:void(0)" class="setDefault">设为默认</a>').remove();
                                $this.after('<span class="default">默认地址</span>');
                                $this.remove();

                            }
                        }

                    });
                    return false;
                });

                $('#user-addresses').on('click','.mod',function(){

                    $('#addNewAd .strong-header').html('修改收货地址');
                    var $this=$(this);
                    var $rootObj=$this.closest('.addresses');
                    strCheck=$rootObj.find('.adrLabel').hasClass('addressCheck')?'addressCheck':'';

                    $('#addressSubmit').attr('data-check',strCheck);
                    var param={
                        operation:'query',
                        address_id:$rootObj.attr('data-id')
                    }
                    var address_id=param.address_id;
                    if(!$('#addressfm input[name=address_id]')[0]){
                        $('#addressfm').append('<input type="hidden"  name="address_id" value="'+address_id+'" />');
                    }else{
                        $('#addressfm input[name=address_id]').val(address_id);
                    }

                    $.getJSON('/member/address.html',param,function(r){
                        $('#name').val(r.user_name);
                        $('#address').val(r.address);
                        $('#card_num').val(r.card_num);
                        $('#phone').val(r.phone);

                        var $province=$('.zp-province .option[title='+r.province+']');
                        var valProvince=$province.attr('value');
                        $('.zp-province .result').html(r.province).attr('value',valProvince);
                        $province.addClass('curr');
                        var param={
                            parent_id:valProvince,
                            query_type:'city'
                        }
                        $('.zp-city,.zp-district').remove();
                        ht.util.location.get(param,ht.util.location.locationClass[1],1,function(){
                            var $city=$('.zp-city .option[title='+r.city+']');
                            var valCity=$city.attr('value');
                            $('.zp-city .result').html(r.city).attr('value',valCity);
                            $city.addClass('curr');

                            var param={
                                parent_id:valCity,
                                query_type:'area'
                            }
                            ht.util.location.get(param,ht.util.location.locationClass[2],2,function(){                            var $area=$('.zp-district .option[title='+r.area+']');
                                var valArea=$area.attr('value');
                                $('.zp-district .result').html(r.area).attr('value',valArea);
                                $area.addClass('curr');
                                $('#myLocation').val('1');
                                _this.setProCityArea();
                                $('.Validform_checktip').removeClass().addClass('Validform_checktip').empty();
                                $("html,body").animate({scrollTop:$("#addNewAddress").offset().top},500);

                            });
                        });
                        $('#addNewAd').show();
                    });
                    return false;
                });

                $('#user-addresses').on('click','.del',function(){

                    var $this=$(this);
                    ht.util.popAlert.run(function(){
                        var str=ht.util.popAlert.confirm('您确定要删除吗？','iDialogDelAddress')
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#iDialogDelAddress .iDialogYes').click(function(){
                            var param={
                                _xsrf:$('input[name=_xsrf]').val(),
                                address_id:$this.closest('.addresses').attr('data-id')
                            }
                            $.ajax({
                                url: '/member/address.html',
                                data:param,
                                type: 'DELETE',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $this.closest('.addresses').remove();
                                        $('#addressfm')[0].reset();
                                        $('.Validform_checktip').removeClass().addClass('Validform_checktip');

                                        if($('#user-addresses .addresses').size()==0){
                                            $('#addNewAd').show();
                                        }else{
                                            $('#addNewAd').hide();
                                        }

                                    }
                                }
                            });
                            $.unblockUI();
                        });
                    });
                    return false;

                });



                $('#submitOrderBtn').click(function(){
                    function checkCardPhone(){
                        var errExtension='身份证图片格式错误';
                        var errTxt='请上传身份证正反面';
                        var $wrongimg=$('#wrongimg');
                        var isOk=true;
                        if($('#font_card').val()=='' || $('#back_card').val()==''){
                            $wrongimg.addClass('Validform_wrong').html(errTxt).show();
                            isOk= false;
                            return isOk;
                        }
                        if($('#font_card').val()!=''){
                            if(ht.util.checkPictureType($('#font_card').val())==0){
                                $wrongimg.addClass('Validform_wrong').html(errExtension).show();
                                isOk = false;
                                return isOk;
                            }else{
                                $wrongimg.hide();
                            }

                        }
                        if($('#back_card').val()!=''){
                            if(ht.util.checkPictureType($('#back_card').val())==0){
                                $wrongimg.addClass('Validform_wrong').html(errExtension).show();
                                isOk = false;
                                return isOk;
                            }else{
                                $wrongimg.hide();
                            }
                        }
                        isOk = true;
                        return isOk;
                    }
                    if( $('#user-addresses .addresses').size()==0 ){
                        ht.util.popAlert.run(function(){
                            var str=ht.util.popAlert.alert('请先填写邮寄地址！');
                            $.blockUI.defaults.css.textAlign='justify';
                            $.blockUI({
                                css: {
                                    width: '520px'
                                },
                                message: str
                            });
                        });

                        return false;
                    }
                    var dataid=$('#user-addresses .addressCheck').parent().attr('data-id');
                    $('#address_id').val(dataid);
                    if($('#address_id').val()==''){
                        ht.util.popAlert.run(function(){
                            var str=ht.util.popAlert.alert('请先选择邮寄地址！');
                            $.blockUI.defaults.css.textAlign='justify';
                            $.blockUI({
                                css: {
                                    width: '520px'
                                },
                                message: str
                            });
                        });

                        return false;
                    }

                    if($('#is_abroad').val()=='True'){
                        if($('.addressCheck').parent().attr('data-card-num')=='False'){
                            ht.util.popAlert.run(function(){
                                var str=ht.util.popAlert.alert('请填写收货人身份证信息！');
                                $.blockUI.defaults.css.textAlign='justify';
                                $.blockUI({
                                    css: {
                                        width: '520px'
                                    },
                                    message: str
                                });
                            });
                            $('.addressCheck').find('.mod').click();
                            return false;
                        }
                    }else{
                        if($('.addressCheck').parent().attr('data-card-img')=='False'){
                            $("#idCardPhotos").show();
                        }
                    }
                    if(!$("#idCardPhotos").is(":hidden")){
                        var isOk=checkCardPhone();
                        if(!isOk){
                            return false;
                        }
                    }
                    if(!$('.m-checkbox').hasClass('m-checked')){
                        ht.util.popAlert.run(function(){
                            var str=ht.util.popAlert.confirm('您是否同意并接受《全球抢购服务协议》？','iDialogDelAgreement')
                            $.blockUI.defaults.css.textAlign='justify';
                            $.blockUI.defaults.css.fontSize=20;
                            $.blockUI({
                                css: {
                                    width: '520px'
                                },
                                message: str
                            });
                            $('#iDialogDelAddress .iDialogYes').click(function(){

                                $.unblockUI();
                                ht.order.sendOrder();
                                return false;
                                //$('#orderSubmitForm').submit();
                            });
                        });
                        return false;
                    }
                    //ht.order.sendOrder();
                    //return false;
                    if(!$('.ui-center-loading')[0]){
                        $('<div class="ui-center-loading"></div>').appendTo('body');
                    }

                    $('.ui-mask').show();

                    $('#orderSubmitForm')[0].submit();


                });
                $('#addNewAddress').click(function(){
                    $('#addNewAd .strong-header').html('新增收货地址');
                    $('.zp-province .result').html('--省/直辖市--').attr('value','');
                    $('.zp-province .curr').removeClass('curr');
                    $('.zp-city,.zp-district').remove();
                    $('#addressfm')[0].reset();
                    $('.Validform_checktip').removeClass().addClass('Validform_checktip');
                    $('#addressfm input[name=address_id]').remove();
                    $('#addNewAd').show();
                });

                $('#m-idcardtip').hover(function(){
                    $(this).next('.m-notice-idcard').show();
                },function(){
                    $(this).next('.m-notice-idcard').hide();
                });


            }

        },
        orderdetail:{
            init:function(){
                this.bindEvent();
            },
            bindEvent:function(){
                $('.confirmReceived').on('click',function(){
                    var $this=$(this);
                    ht.util.popAlert.run(function(){
                        var str=ht.util.popAlert.confirm('您收到包裹了吗？','iDialogRecOrder','确认收货');
                        str=str.replace(/<span>确认<\/span>/g,'<span>已收到货</span>');
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#iDialogRecOrder .iDialogYes').click(function(){
                            var order_Id=$this.attr('data-id');
                            var param={
                                _xsrf:$('input[name=_xsrf]').val()
                            }

                            $.ajax({
                                url: '/order/order_'+order_Id+'.html',
                                data:param,
                                type: 'PUT',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $('#orderdetail .trieTips').html('当前状态：交易成功 ');
                                        $('#orderdetail .trieTime').html('交易成功');
                                        $this.remove();
                                        $.unblockUI();
                                    }
                                }
                            });

                        });
                    });
                });

                $('#J_cancelOrderBtn').on('click',function(){
                    var $this=$(this);
                    ht.util.popAlert.run(function(){
                        var str=$('#templateCancelOrder').tmpl({id:1});
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });

                        $('#iDialogCancelOrder .result-wrap').click(function(){
                            if($('#iDialogCancelOrder .cp-arrow').hasClass('cp-arrow-down')){
                                $('#iDialogCancelOrder .options').show();
                                $('#iDialogCancelOrder .cp-arrow').removeClass('cp-arrow-down').addClass('cp-arrow-up');
                            }else{
                                $('#iDialogCancelOrder .options').hide();
                                $('#iDialogCancelOrder .cp-arrow').removeClass('cp-arrow-up').addClass('cp-arrow-down');
                            }


                        });
                        $('#iDialogCancelOrder .option').click(function(){
                            $('#iDialogCancelOrder .result').html($(this).html())
                                .attr('value',$(this).attr('value'));
                            $('#iDialogCancelOrder .options').hide();
                            $('#iDialogCancelOrder .cp-arrow').removeClass('cp-arrow-up').addClass('cp-arrow-down');
                        });
                        $('#iDialogCancelOrder .cancelOrderBtnOk').click(function(){
                            //
                            var order_Id=$this.attr('data-id');
                            var param={
                                _xsrf:$('input[name=_xsrf]').val(),
                                cancle_reason:$('#iDialogCancelOrder .result').html()
                            }
                            if(console){
                                console.log(param.cancle_reason);
                            }
                            $.ajax({
                                url: '/order/order_'+order_Id+'.html',
                                data:param,
                                type: 'DELETE',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $('#orderdetail .trieTips').html('当前状态：交易关闭 ');
                                        $('#orderdetail .trieTime').html('交易关闭');
                                        $this.parent().remove();
                                        $.unblockUI();
                                    }
                                }
                            });

                        });
                    });
                });
            }
        },
        sendOrder:function(callback){
            $.ajax({
                type: "POST",
                url: "/order/order.html",
                data: $("#orderSubmitForm").serializeArray(),
                success: function(r){
                    r=JSON.parse(r);
                    if(r.state==200){
                        window.location.href= r.info;
                    }else{
                        //$('#orderWarning').html(r.info);
                        ht.util.popAlert.run(function(){
                            var str=ht.util.popAlert.alert(r.info);
                            $.blockUI.defaults.css.textAlign='justify';
                            $.blockUI({
                                css: {
                                    width: '520px'
                                },
                                message: str
                            });
                        });
                    }
                }
            });
        },
        payway:{
            init:function(){

                $('#payway').on('click','.banks',function(){
                    $(this).find('.wrapnRadio').addClass('nRadioChecked');
                    $(this).find('.bankinfo').addClass('checked');
                    $(this).siblings().find('.bankinfo').removeClass('checked');
                    $(this).siblings().find('.wrapnRadio').removeClass('nRadioChecked').addClass('nRadio');
                    var dataAction=$(this).find('.bankinfo').attr('data-action');
                    $('#paywayform').attr('action',dataAction);

                });
                $('#payBtn').click(function(){
                    ht.util.popAlert.run(function(){
                        var str='<div class="iDialogHead"><h1>提示</h1></div><a href="javascript:;" id="paywayCloseIcon" class="closeIcon">×</a>';
                        var reval  = "";
                        reval += "<div id=\"paywayDialog\" class=\"iDialogBody\">";
                        reval += "<div class=\"iDialogMain\">";
                        reval += "<div class=\"prompt\">";
                        reval += "<ul>";
                        reval += "<li class=\"icon\"><i></i>请在第三方支付页面完成付款</li>";
                        reval += "<li>付款完成前请不要关闭此窗口</li>";
                        reval += "<li></li>";
                        reval += "<li><a class=\"paySuccess\" href=\"javascript:void(0)\">我已付款成功</a><a class=\"otherPayWay\" href=\"javascript:void(0)\">付款遇到问题，重新支付</a> ";
                        reval += "</li>";
                        reval += "<li></li>";
                        reval += "<li class=\"haveProblem\"><a href=\"#\">> 联系人工服务</a>";
                        reval += "</li>";
                        reval += "</ul>";
                        reval += "</div>";
                        reval += "</div>";
                        reval += "</div>";
                        str+=reval;
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#paywayDialog .paySuccess,#paywayDialog .otherPayWay').click(function(){
                            window.location.reload();
                        });
                        $('#paywayCloseIcon').click(function(){
                            $.unblockUI();
                        });
                    });

                });



            }
        }
    }
    $(function(){
        ht.order.init();
    });
})(window);

