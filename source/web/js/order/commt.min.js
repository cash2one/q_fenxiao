(function( window, undefined ) {
    ht.commt={
        init:function(){
            this.rate.init();
            this.valid.init();
            this.bindEvent();
        },
        assess_level:['差评','中评','好评'],
        rate:{
            init:function(){
                var _this=this;
            },
            tips:['差评','较差','一般','满意','非常满意']
        },
        valid:{
            init:function(){
                datatype=ht.util.validformParam.datatype;
                $('.cmtform').each(function(){
                    var $this=$(this);
                    $this.Validform({//所有可传入的参数如下：;
                        btnSubmit:".btnCommt",
                        tiptype:3,
                        datatype: ht.util.validformParam.datatype,
                        callback:function(){
                            ht.util.popAlert.loading(function(){
                                var pngArr=[];
                                $this.find('.myshowpng').each(function(){
                                    pngArr.push($(this)[0].src);
                                });
                                var show_imgs=pngArr.join(';');
                                var params={
                                    item_id:$this.attr('data-item-id'),
                                    order_id:$this.attr('data-order-id'),
                                    order_no:$this.attr('data-order-no'),
                                    assess_level:$this.find('input[name=assess_level]:checked').val(),
                                    comment:$this.find('textarea[name=comment]').val(),
                                    show_imgs:show_imgs,
                                    _xsrf:$('input[name=_xsrf]').val()
                                }
                                $.post('/item/comment.html',params,function(r){
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $this.find('.listDis').empty();
                                        var dataJson= r.data;
                                        dataJson.comment_id= r.comment_id;
                                        dataJson.boysphotos=[];
                                        if(dataJson.show_imgs!=''){
                                            var tomsPhoto=[];
                                            var arrayPhotos=dataJson.show_imgs.split(';');
                                            for(var i= 0,len=arrayPhotos.length;i<len;i++){
                                                tomsPhoto.push({'tomsPhoto':arrayPhotos[i]})
                                            }
                                            dataJson.boysphotos=tomsPhoto;
                                        }
                                        dataJson.item_id=params.item_id;
                                        dataJson.assess=ht.commt.assess_level[parseInt(dataJson.assess_level)];

                                        $('#templateHisCmtInfos').tmpl(dataJson).appendTo($this.find('.listDis'));

                                        $this.find('.blueRight').show();
                                        $.unblockUI();
                                    }

                                });
                            });

                            return false;
                        }
                    });
                });

            }
        },
        bindEvent:function(){
            $("#rateCon").on('change','.file',function() {
                var fileName = $(this).val().toLowerCase();
                if (ht.util.checkPictureType(fileName)==0 ) {
                    alert( "只支持.gif .png .jpg .jpeg格式图片");
                    return false;
                }

                if($(this)[0].files) {
                    var filesize = $(this)[0].size;
                    if(filesize > 3*1024*1024) {
                        alert("加载图片失败，头像不能大于3M");
                        return false;
                    }
                }
                ht.commt.ajaxFileUpload($(this)[0].id);
            });
            $('.showBuyting').on('click','.delPhoto',function(){
                $(this).closest('.showBuyting').find('.seeupload').show();
                $(this).closest('.usersShow').remove();
            });

            $('.hisphotos').click(function(){
                var $this=$(this);
                var dataSrc=$this.attr('data-src');

                var id='BlockImage'+Math.random();
                var data={
                    id:id,
                    dataSrc:dataSrc
                }
                var popStr=$('#templateHisPhotos').tmpl(data);
                ht.util.popAlert.run(function(){
                    $.blockUI({
                        css: {
                            top:		'50%',
                            left:		'50%',
                            marginLeft:     '-260px',
                            marginTop:      '-260px',
                            width: '520px',
                            height:'520px',
                            textAlign:'justify'
                        },
                        message: popStr
                    });
                });
            });

            $('.commtAgain').on('click',function(){
                var $root=$(this).closest('.dataList');
                $root.find('.disCmtAgain').show();
            });

            $('#rateCon').on('click','.btnCommtAgain',function(){
                var $btn=$(this);
                var $root=$(this).closest('.commtAgainform');
                var $this=$root;
                ht.util.popAlert.loading();
                var pngArr=[];
                $this.find('.myshowpng').each(function(){
                    pngArr.push($(this)[0].src);
                });
                var show_imgs=pngArr.join(';');
                var params={
                    comment_id:$this.attr('data-comment-id'),
                    addition_comment:$this.find('textarea[name=comment]').val(),
                    add_show_imgs:show_imgs,
                    _xsrf:$('input[name=_xsrf]').val()
                }
                $.post('/item/comment.html',params,function(r){
                        r=JSON.parse(r);
                        if(r.state==200){
                            var dataJson= r.data;
                            dataJson.boysphotos=[];
                            if(dataJson.add_show_imgs!=''){
                                var tomsPhoto=[];
                                var arrayPhotos=dataJson.add_show_imgs.split(';');
                                for(var i= 0,len=arrayPhotos.length;i<len;i++){
                                    tomsPhoto.push({'tomsPhoto':arrayPhotos[i]+'@100w','tomsPhotoBig':arrayPhotos[i]+'@400w'})
                                }
                                dataJson.boysphotos=tomsPhoto;
                            }

                            $('#templateHisCmtAgainInfos').tmpl(dataJson).appendTo($root.parent().parent());
                            $btn.remove();
                            $root.parent().remove();
                            $.unblockUI();
                        }
                });
            });


        },
        ajaxFileUpload:function(id) {
            var $objLoading=$('#'+id).prev('.loading');
            var $root=$('#'+id).closest('.showBuyting');
            $root.find('.seeupload').hide();
            $objLoading.show();
            $.ajaxFileUpload( {
                url : '/item/comment/uploadimage.html',//用于文件上传的服务器端请求地址
                secureuri : false,//一般设置为false
                fileElementId : id,//文件上传控件的id属性
                dataType : 'json',//返回值类型 一般设置为json
                success : function(data, status) //服务器成功响应处理函数
                {
                    r=data;
                    if(r.state==200){
                        $('#'+id).parent().after('<li class="usersShow"><div class="userphotos"><a href="javascript:void(0)" class="delPhoto"></a><img alt="图片"  class="myshowpng" src="'+ r.url+'@100w"></div></li>');
                        if($root.find('.usersShow').length==5){
                            $root.find('.seeupload').hide();
                        }else{
                            $root.find('.seeupload').show();
                        }
                    }
                },
                error : function(data, status, e)//服务器响应失败处理函数
                {
                    //alert(e);
                },
                complete:function() {
                    $objLoading.hide();
                }
            })
            return false;
    }
    }
    $(function(){
        ht.commt.init();
    });
})(window);


