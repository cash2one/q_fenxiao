(function( window, undefined ) {
    ht.member={
        init:function(){
            ht.util.shopcartFix.init();
            this.modAddress.init();
            this.modOrder.init();
            this.modCollect.init();
        },
        modAddress:{
            init:function(){
                if(!$('#modAddress')[0]){return false}
                ht.util.location.init();
                this.showNullAdd();
                this.validAddress();
                this.bindEvent();
            },
            showNullAdd:function(){
                if($('.oAddress tbody tr').length==0){
                    $('#addressedit').show();
                }
            },
            setProCityArea:function(){
                var $result=$('#provicecityarea .result');
                $('#province').val($result.eq(0).attr('value')).attr('data-title',$result.eq(0).html());
                $('#city').val($result.eq(1).attr('value')).attr('data-title',$result.eq(1).html());
                $('#area').val($result.eq(2).attr('value')).attr('data-title',$result.eq(2).html());

            },
            validAddress:function(){
                var _this=this;
                var $cardNum=$('#card_num');
                $cardNum.blur(function(){
                   if($(this).val()==''){
                       $cardNum.next('.Validform_checktip').html('').removeClass('Validform_wrong');
                   }
                });
                $("#addressform").Validform({//所有可传入的参数如下：;
                    btnSubmit:"#addressSubmit",
                    btnReset:"",
                    tiptype:3,
                    ignoreHidden:false,
                    ajaxPost:true,
                    datatype: ht.util.validformParam.datatype,
                    beforeCheck:function(curform){
                        //_this.setProCityArea();
                    },
                    beforeSubmit:function(curform){
                        _this.setProCityArea();
                        if( $cardNum.val()!=''){
                            if(ht.util.validformParam.datatype.idcard($cardNum.val())!=true){
                                $cardNum.next('.Validform_checktip').html($cardNum.attr('errormsg')).addClass('Validform_wrong');
                                return false;
                            }
                        }else{
                            $cardNum.next('.Validform_checktip').html('').removeClass('Validform_wrong');
                        }

                    },
                    ajaxpost:{
                        error:function(data,obj){

                        }
                    },
                    callback:function(data){
                        if(data.status=="y"){
                            $.Hidemsg();
                            var addressdetail=$('#province').attr('data-title')+$('#city').attr('data-title')+$('#area').attr('data-title')+$('#address').val();
                            var resultAdd = [
                                {
                                    name:$('#name').val(),
                                    addressdetail:addressdetail,
                                    phone:$('#phone').val(),
                                    addressid:data.addressId
                                }
                            ];
                            if(!$('#address_id')[0]){
                                $('#modAddress .oAddress tbody').append($('#templateoAddress').tmpl(resultAdd));
                            }else{
                                var dataId=$('#address_id').val();
                                var $tr=$('#modAddress .oAddress tbody tr[data-id='+dataId+']');
                                $tr.after($('#templateoAddress').tmpl(resultAdd));
                                $tr.remove();

                            }
                            $('.Validform_checktip').removeClass().addClass('Validform_checktip');
                            $('#addressform')[0].reset();
                            $('#addressedit').hide();
                            $("html,body").animate({scrollTop:0},500);
                        }else{
                            $.Showmsg(data.info);
                            return false;
                        }
                    }
                });
            },
            bindEvent:function(){
                var _this=this;
                $('#m-idcardtip').hover(function(){
                    $(this).next('.m-notice-idcard').show();
                },function(){
                    $(this).next('.m-notice-idcard').hide();
                });
                $('#linkAddAddress').click(function(){
                    $('.zp-province .result').html('--省/直辖市--').attr('value','');
                    $('.zp-province .curr').removeClass('curr');
                    $('.zp-city,.zp-district').remove();
                    $('#address_id').remove();
                    $('#addressform')[0].reset();
                    $('#lblAddAddress').html('新增收货地址').show();
                    $('#newAddress,#addressedit').show();
                });
                $('#newAddress .closeIcon').click(function(){
                    $('#newAddress,#lblAddAddress').hide();
                });
                //delete address
                $('#modAddress').on('click','.addDel',function(){
                    var $this=$(this);
                    ht.util.popAlert.run(function(){
                        var str=ht.util.popAlert.confirm('您确定要删除吗？','iDialogDelAddress')
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#iDialogDelAddress .iDialogYes').click(function(){
                            var param={
                                _xsrf:$('input[name=_xsrf]').val(),
                                address_id:$this.closest('tr').attr('data-id')
                            }
                            $.ajax({
                                url: '/member/address.html',
                                data:param,
                                type: 'DELETE',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $this.closest('tr').remove();
                                        $('#addressform')[0].reset();
                                        ////$('#newAddress,#lblAddAddress').show();
                                        ht.member.modAddress.showNullAdd();

                                    }
                                }
                            });
                            $.unblockUI();
                        });
                    });
                });
                $('#modAddress').on('click','.addUpdate',function(){
                    var $this=$(this);
                    var param={
                        operation:'query',
                        address_id:$this.closest('tr').attr('data-id')
                    }
                    var address_id=param.address_id;
                    $.getJSON('/member/address.html',param,function(r){
                        if(!$('#address_id')[0]){
                            $('#addressform').append('<input type="hidden" id="address_id" name="address_id" value="'+address_id+'" />');
                        }else{
                            $('#address_id').val(address_id);
                        }

                        $('#name').val(r.user_name);
                        $('#address').val(r.address);
                        $('#card_num').val(r.card_num);
                        $('#phone').val(r.phone);

                        var $province=$('.zp-province .option[title='+r.province+']');
                        var valProvince=$province.attr('value');
                        $('.zp-province .result').html(r.province).attr('value',valProvince);
                        $province.addClass('curr');
                        var param={
                            parent_id:valProvince,
                            query_type:'city'
                        }
                        $('.zp-city,.zp-district').remove();
                        ht.util.location.get(param,ht.util.location.locationClass[1],1,function(){
                            var $city=$('.zp-city .option[title='+r.city+']');
                            var valCity=$city.attr('value');
                            $('.zp-city .result').html(r.city).attr('value',valCity);
                            $city.addClass('curr');

                            var param={
                                parent_id:valCity,
                                query_type:'area'
                            }
                            ht.util.location.get(param,ht.util.location.locationClass[2],2,function(){                            var $area=$('.zp-district .option[title='+r.area+']');
                                var valArea=$area.attr('value');
                                $('.zp-district .result').html(r.area).attr('value',valArea);
                                $area.addClass('curr');
                                $('#myLocation').val('1');
                                _this.setProCityArea();

                            });
                        });
                        $('.Validform_checktip').removeClass().addClass('Validform_checktip').empty();
                        $('#lblAddAddress').html('修改收货地址').show();
                        $('#newAddress,#addressedit').show();
                        $("html,body").animate({scrollTop:$("#lblAddAddress").offset().top},500);
                    });

                });


                $('#modAddress').on('click','.setDefault',function(){
                    var param={
                        address_id:$(this).closest('tr').attr('data-id')
                    };
                    var $this=$(this);

                    $.get('/member/address.html',param,function(r){
                        r=JSON.parse(r);
                        if(r.state==200){
                            $('#modAddress .default').after('<a href="javascript:void(0)" class="setDefault">设为默认</a>').remove();
                            $this.after('<span class="default">默认地址</span>');
                            $this.remove();
                        }

                    });
                });
            }
        },
        modOrder:{
            init:function(){
                if(!$('#modOrder')[0]){return false}
                this.bindEvent();
                this.fixBorder();
            },
            fixBorder:function(){
                $('.myOdr_tb2').each(function(){
                    $(this).find('tr:last').removeClass('hasborder')
                });

            },
            bindEvent:function(){
                //删除订单
                $('.garbage').click(function(){
                    ht.util.popAlert.run(function(){
                        var str=ht.util.popAlert.confirm('您确定要删除该订单吗？','iDialogDelOrder')
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#iDialogDelOrder .iDialogYes').click(function(){
                            alert('删除');
                            $.unblockUI();
                        });
                    });
                });
                //cancel order
                $('.cancelOrder').click(function(){
                    var $this=$(this);
                    var $root=$this.closest('tr.border');
                    ht.util.popAlert.run(function(){
                        var str=$('#templateCancelOrder').tmpl({id:1});
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#iDialogCancelOrder .result-wrap').click(function(){
                            if($('#iDialogCancelOrder .cp-arrow').hasClass('cp-arrow-down')){
                                $('#iDialogCancelOrder .options').show();
                                $('#iDialogCancelOrder .cp-arrow').removeClass('cp-arrow-down').addClass('cp-arrow-up');
                            }else{
                                $('#iDialogCancelOrder .options').hide();
                                $('#iDialogCancelOrder .cp-arrow').removeClass('cp-arrow-up').addClass('cp-arrow-down');
                            }


                        });
                        $('#iDialogCancelOrder .option').click(function(){
                            $('#iDialogCancelOrder .result').html($(this).html())
                                .attr('value',$(this).attr('value'));
                            $('#iDialogCancelOrder .options').hide();
                            $('#iDialogCancelOrder .cp-arrow').removeClass('cp-arrow-up').addClass('cp-arrow-down');
                        });
                        $('#iDialogCancelOrder .cancelOrderBtnOk').click(function(){
                            //
                            var orderId=$root.attr('data-id');
                            var itemFirst=$root.find('.item:first').attr('data-itemid');

                            var param={
                                _xsrf:$('input[name=_xsrf]').val(),
                                cancle_reason:$('#iDialogCancelOrder .result').html()
                            }
                            if(console){
                                console.log(param.cancle_reason);
                            }
                            $.ajax({
                                url: '/order/order_'+orderId+'.html',
                                data:param,
                                type: 'DELETE',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $root.find('.orderStatusBtn').html('订单关闭');
                                        $root.find('.operate').html('<a class="againBuy" href="/item/detail/'+itemFirst+'.html">再次购买</a>');
                                        $.unblockUI();
                                    }
                                }
                            });

                        });

                    });
                });

                $('.getWuliu').on('click',function(){
                    var offset = $(this).offset();
                    var did=$(this).attr('data-id');
                    $('#wuliuInfo').empty().show().css({'left':offset.left-80,'top':offset.top+20});
                    $('#templateWuliuLoading').tmpl([{id:1}]).appendTo('#wuliuInfo');
                    $.getJSON('/member/order/express_check/'+did+'.html',function(r){
                        if(r.state==200){
                            r.number=1;

                            r.data[0].className='first';
                            r.data[r.data.length-1].className='last';
                            var waybillJson= [
                                {
                                    number:1,
                                    WaybillNumber: r.WaybillNumber,
                                    company: r.company_name,
                                    data:r.data
                                }
                            ];
                            $('#wuliuInfo').empty().show().css({'left':offset.left-80,'top':offset.top+20});
                            $('#templateWuliu').tmpl(waybillJson).appendTo('#wuliuInfo');
                            if(r.data.length>2){
                                $('#wuliuInfo .infoWrap:first').addClass('last');
                            }
                        }
                        else{
                            $('#wuliuInfo').empty().show().css({'left':offset.left-80,'top':offset.top+20}).addClass('wuliuError');
                            $('#templateWuliuError').tmpl([{id:1}]).appendTo('#wuliuInfo');

                        }
                    });

                });

                $('.confirmReceived').on('click',function(){
                    var $this=$(this);
                    var $root=$this.closest('tr.border');
                    ht.util.popAlert.run(function(){
                        var str=ht.util.popAlert.confirm('您收到包裹了吗？','iDialogRecOrder','确认收货');
                        str=str.replace(/<span>确认<\/span>/g,'<span>已收到货</span>');
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        $('#iDialogRecOrder .iDialogYes').click(function(){
                            var order_no=$root.attr('data-no');
                            var order_Id=$root.attr('data-id');
                            var itemFirst=$root.find('.item:first').attr('data-itemid');

                            var param={
                                _xsrf:$('input[name=_xsrf]').val()
                            }

                            $.ajax({
                                url: '/order/order_'+order_Id+'.html',
                                data:param,
                                type: 'PUT',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $root.find('.orderStatusBtn').html('订单关闭');
                                        $root.find('.operate').html('<a class="letmcmt comment btn-white30" href="#">评价</a><a class="againBuy" href="/item/detail/'+itemFirst+'.html">再次购买</a>');

                                        $('#iDialogRecOrder').empty();
                                        $('#templateRecOk').tmpl({order_no:order_no}).appendTo('#iDialogRecOrder');
                                        //$.unblockUI();
                                    }
                                }
                            });

                        });
                    });
                });
                $(document).click(function(e){
                    var target  = $(e.target);
                    if(target.closest(".getWuliu").length == 0 && target.closest("#wuliuInfo").length==0 ){
                        $('#wuliuInfo').hide();
                    }
                });
            }
        },
        modCollect:{
            init:function(){
                if(!$('#modCollect')[0]){return false}
                $('#result .delete').click(function(){
                    var $this=$(this);
                    ht.util.popAlert.run(function(){
                        var str=ht.util.popAlert.confirm('从我的收藏中删除？','iDialogDelFav');
                        $.blockUI.defaults.css.textAlign='justify';
                        $.blockUI({
                            css: {
                                width: '520px'
                            },
                            message: str
                        });
                        var param={
                            _xsrf:$('input[name=_xsrf]').val(),
                            item_id:$this.attr('data-itemId')
                        }
                        $('#iDialogDelFav .iDialogYes').click(function(){
                            $.ajax({
                                url: '/member/collections.html',
                                data:param,
                                type: 'DELETE',
                                success: function(r) {
                                    r=JSON.parse(r);
                                    if(r.state==200){
                                        $this.parent().remove()
                                        var count=parseInt($('#collectionCount').text(),10)-1;
                                        $('#collectionCount').text(count);
                                    }
                                }
                            });
                            $.unblockUI();
                        });
                    });
                });
            }
        }

    }
    $(function(){
        ht.member.init();
    });
})(window);
