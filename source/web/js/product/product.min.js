(function(b){var c={largewidth:800,largeheight:800};var a=function(f){f=b.extend({},c,f);var o=b(this);var k=b(this).find("b");var m=b("#showImgBig");var i=b("#showDetails");var d={width:400,height:400};var p={width:800,height:800};var g=b("#showImgBox").offset();var n={x:200/2,y:200/2};var e={width:d.width-200,height:d.height-200};var l=function(){k.show();i.show()};var h=function(){k.hide();i.hide()};var j={x:d.width/p.width,y:d.height/p.height};o.mousemove(function(r){var q=r.pageX-g.left;var s=r.pageY-g.top;q=q-n.x;s=s-n.y;if(q<0){q=0}if(s<0){s=0}if(q>e.width){q=e.width}if(s>e.height){s=e.height}k.css({left:q,top:s});m.css({left:(0-q/j.x),top:(0-s/j.y)})}).mouseenter(l).mouseleave(h)};b.fn.extend({enlarge:a})})(jQuery);
ht.product={
    init:function(){
        this.showPhoto.init();
        this.navFix.init();
        this.similar.init();
        this.hisGoods.init();
        ht.util.shopcartFix.init();
        this.commt.init();
        this.bindEvent();
        //this.countBackwards();

        $('#pageNavWrap').on('keyup','.jumptoTxt',function(){
            var $this=$(this);
            if($this.val().length==1){
                $this.val($(this).val().replace(/[^1-9]/g,''))
            } else{
                $this.val($(this).val().replace(/\D/g,''))
            }
        });
        this.cartBar.init();
    },
    //倒计时
    countBackwards:function(){
        if(!$("#countBackwards")[0]){return;}
        function parseTen(s){
            return s<10?'0'+s:s;
        }
        function FreshTime()
        {
            var endtime=new Date("2015/12/15,8:18:00");//结束时间
            var nowtime = new Date();//当前时间
            var lefttime=parseInt((endtime.getTime()-nowtime.getTime())/1000);
            d=parseInt(lefttime/3600/24);
            h=parseInt((lefttime/3600)%24);
            m=parseInt((lefttime/60)%60);
            s=parseInt(lefttime%60);
            var $countBackwards=$("#countBackwards");
            if(lefttime<=0){
                $countBackwards.html("团购已结束");
                $('#m_temaiDom').remove();
                clearInterval(sh);
            }else{
                $countBackwards.html('距结束：<span class="num day">'+parseTen(d)+'</span>天<span class="num hour">'+parseTen(h)+'</span>时<span class="num min">'+parseTen(m)+'</span>分<span class="num sec">'+parseTen(s)+'</span>秒<span class="num milsec"></span>');
            }
        }
        FreshTime();
        var sh;
        sh=setInterval(FreshTime,1000);
    },
    navFix:{
        init:function(){
            ht.util.sticky($('#P_nav'),function(){
                $('#P_nav').addClass('P_navFix');
            },function(){
                $('#P_nav').removeClass('P_navFix');
            });
        }
    },
    isHasLoad:0,
    bindEvent:function(){
        var goodsDetaiTop=$('.goodsDetailWrap').offset().top;
        $('#goodsDetail_T').click(function(){
            $(this).addClass('active').siblings().removeClass('active');
            $('#goodsDetail').show();
            $(window).scrollTop(goodsDetaiTop);
        });
        $('#userRating_T').click(function(){
            ht.product.isHasLoad=1;
            $(this).addClass('active').siblings().removeClass('active');
            $('#goodsDetail').hide();
            $(window).scrollTop(goodsDetaiTop);
        });
        $('#scrollTop2').click(function(){
            $(window).scrollTop(0);
        });
        $('#js_skuBox').on('click','.m-favbtn',function(){
            var $this=$(this);
            if($(this).hasClass('got')){return false;}
            $.getJSON('/checklogin.html',function(r){
                if(r.state==200){
                    if(r.is_login==1){
                        var param={
                            _xsrf:$("input[name=_xsrf]").val(),
                            item_id:$('#item_id').val()
                        }
                        $.post('/member/collections.html',param,function(r){
                            r=JSON.parse(r);
                            if(r.state==200){
                                $this.html('<i class="iconfont ic"></i><span class="txt">已收藏</span>').addClass('got');
                            }
                        });
                    }else{
                        $('#js_skuBox').attr('needCollect','1');
                        $('.login').click();
                    }
                }
            });

        });


    },
    commt:{
        init:function(){
            this.showMyPhoto();
            this.getFirstCmt();
            this.bindEvent();
        },
        pageSize:20,
        level:'',
        bindEvent:function(){
            var _this=this;
            $('#userRating').on('click','.wrapnRadio',function(){
                var $this=$(this);
                var level=$this.find('input[name=commentSelect]').val();
                ht.product.commt.level=level;
                var cmtCount=parseInt($this.attr('data-count'),10);
                var perNum=ht.product.commt.pageSize;
                $("#pageBox").pagination(cmtCount, {
                    current_page:0,
                    num_edge_entries: 2,
                    num_display_entries: 4,
                    prev_text:"上一页",
                    next_text:"下一页",
                    callback: ht.product.commt.pageselectCallback,
                    items_per_page:perNum
                });

                //ht.product.commt.getCmt(0,level);
            });
        },
        pageselectCallback:function(page_id, jq){
            var level=ht.product.commt.level;
            (!level) && (level='');

            ht.product.commt.getCmt(page_id,level);
        },
        getFirstCmt:function(){
            var cmtCount=parseInt($('#commentCounts').attr('data-comments'),10);
            var perNum=ht.product.commt.pageSize;
            $("#pageBox").pagination(cmtCount, {
                current_page:0,
                num_edge_entries: 2,
                num_display_entries: 4,
                prev_text:"上一页",
                next_text:"下一页",
                callback: ht.product.commt.pageselectCallback,
                items_per_page:perNum
            });
        },
        getCmt:function(pageIndex,level){
                var pageIndex=pageIndex+1;
                var param={
                    item_id:$('#item_id').val(),
                    assess_level:level,
                    page:pageIndex
                }
                $.get('/item/comment_list.html',param,function(r){
                    var data=JSON.parse(r);
                    data.good_percent=data.good_percent*100;
                    data.data=data.data.result;
                    data.dataCmtItems=data.data;
                    data.level=level;

                    var dateToStrYMDHM= QTIMES.date.date_to_str("%Y-%m-%d");

                    for(var i=0,len=data.data.length;i<len;i++){

                        data.data[i].dataCmtPics=[];
                        if(data.data[i].show_imgs!=''){
                            var tomsPhoto=[];
                            var arrayPhotos=data.data[i].show_imgs.split(';');
                            for(var j= 0,lenj=arrayPhotos.length;j<lenj;j++){
                                tomsPhoto.push(
                                    {
                                        'cmtPhoto':arrayPhotos[j],
                                        'cmtPhotoBig':arrayPhotos[j]
                                    }
                                );
                            }
                            data.data[i].dataCmtPics=tomsPhoto;
                        }
                        data.data[i].dataCmtPicsAgain=[];
                        if(data.data[i].add_show_imgs!=''){
                            var tomsPhoto=[];
                            var arrayPhotos=data.data[i].add_show_imgs.split(';');
                            for(var j= 0,lenJ=arrayPhotos.length;j<lenJ;j++){
                                tomsPhoto.push(
                                    {
                                        'cmtPhoto':arrayPhotos[j],
                                        'cmtPhotoBig':arrayPhotos[j]
                                    }
                                );
                            }
                            data.data[i].dataCmtPicsAgain=tomsPhoto;
                        }

                        data.data[i].cmtTime=new Date(data.data[i].gmt_modified*1000);
                        data.data[i].cmtTime=dateToStrYMDHM(data.data[i].cmtTime);
                    }

                    $('#qscmt').empty();

                    $('#templateCmts').tmpl(data).appendTo('#qscmt');
                    if(ht.product.isHasLoad==1){
                        $('#userRating_T').click();
                    }

                });


        },
        showMyPhoto:function(){
            var strPreveiwBox  = "";
            strPreveiwBox += "<div style=\"width: 560px; overflow: hidden; position: relative; display: none;\" class=\"preview_box preview_style\">";
            strPreveiwBox += " <div style=\"height:350px;width:560px;padding-top:60px;overflow:hidden;text-align: center;\">";
            strPreveiwBox += "  <img src=\"\/static\/images\/blank.gif\/\" />";
            strPreveiwBox += " </div>";
            strPreveiwBox += "  <a name=\"js_colse\" title=\"关闭\" class=\"preview_close\" href=\"javascript:;\"></a>";
            strPreveiwBox += "</div>";

            $('#userRating').on('click','.pic_item',function(){
                if($(this).parent().next('.preview_box').size()==0){
                    $(this).parent().after(strPreveiwBox);
                }
                $(this).parent().next('.preview_box').show();
                $(this).parent().next('.preview_box').find('img').attr('src',$(this).find('img')[0].src);
            });
            $('#userRating').on('click','.preview_close',function(){
                $(this).parent().hide();
            });
        }
    },
    showPhoto:{
        init:function(){
            $('#overAmount').mouseover(function(){
                $('.tip-wrap').show();
            });
            $('.tip-wrap').mouseout(function(){
                $(this).hide();
            });
            $('#showImgBox').enlarge();
            $('#litimgUl li').click(function(){
                $(this).addClass('active').siblings().removeClass('active');
                var thisImg=$(this).find('img');
                var obj={
                    mid:thisImg.attr('source'),
                    large:thisImg.attr('lsource')
                }
                $('#showImg').attr('src',obj.mid);
                $('#showImgBig').attr('src',obj.large);
                $('#showLocalImg').attr('href',obj.large);
            });
        }
    },
    cartBar:{
        init:function(){
            this.addToCart();
            this.bindEvent();
            this.buy();
        },
        ops:{
          maxPrice:1000
        },
        limitedByTariff:function(nPrice){
            if($('#is_abroad').val()=='False'){
                return;
            }
            if(nPrice>ht.util.ops.tax[0].maxPrice){
                $('#js_overAmountTip').removeClass('hide');
                $('#buyBtn,.buynowonly,#addCart').addClass('disabled');
            }else{
                $('#js_overAmountTip').addClass('hide');
                $('#buyBtn,.buynowonly,#addCart').removeClass('disabled');
            }
        },
        buy:function(){
            $('#buyBtn,.buynowonly').click(function(){
                if($(this).hasClass('disabled')){
                    return false;
                }
                $('#item-order-form')[0].submit();
                return false;
            });
        },
        bindEvent:function(){
            var $goodsAmount=$('#goodsAmount');
            var minCount=parseInt($goodsAmount.attr('min_count'),10);
            var maxCount=parseInt($goodsAmount.attr('max_Count'),10);
            var goodsPrice=$('#goodsPrice').val();
            var $plus=$('#j_buyboxnum .ctrnum-b-ad');
            var $minus=$('#j_buyboxnum .ctrnum-b-rd');
            $plus.click(function(){
                if( $(this).hasClass('ctrnum-b-dis') ){return}
                if( $goodsAmount.val() >=maxCount ){return}
                var newNumber=parseInt($goodsAmount.val(),10)+1;
                $goodsAmount.val(newNumber);
                $goodsAmount.val()>minCount && $minus.removeClass('ctrnum-b-dis');
                $goodsAmount.val()==maxCount && $(this).addClass('ctrnum-b-dis');
                var nPrice=newNumber*goodsPrice;
                ht.product.cartBar.limitedByTariff(nPrice);

            });
            $minus.click(function(){
                if( $(this).hasClass('ctrnum-b-dis') ){return}
                if( $goodsAmount.val() <=minCount ){return}
                if( $(this).hasClass('ctrnum-b-dis') ){return}
                var newNumber=parseInt($goodsAmount.val(),10)-1;
                $goodsAmount.val(newNumber);
                $goodsAmount.val()==minCount && $(this).addClass('ctrnum-b-dis');
                $goodsAmount.val()<=maxCount && $plus.removeClass('ctrnum-b-dis');
                var nPrice=newNumber*goodsPrice;
                ht.product.cartBar.limitedByTariff(nPrice);
            });



            $('#goodsAmount').keyup(function(){
                if($(this).val().length==1){
                    var v=$(this).val().replace(/[^1-9]/g,'');
                    var val=(v==''||v<minCount)?minCount:v;
                    val=v>maxCount?maxCount:val;
                    $(this).val(val);
                }else{
                    var v=$(this).val().replace(/\D/g,'');
                    var val=(v==''||v<minCount)?minCount:v;
                    val=v>maxCount?maxCount:val;
                    $(this).val(val);
                }
                if( $(this).attr('isNone')==1 ){return}
                if($goodsAmount.val()>minCount){
                    $minus.removeClass('ctrnum-b-dis');
                }else{
                    $minus.addClass('ctrnum-b-dis');
                }
                if($goodsAmount.val()>=maxCount){
                    $plus.addClass('ctrnum-b-dis');
                }else{
                    $plus.removeClass('ctrnum-b-dis');
                }
                var nPrice=val*goodsPrice;
                ht.product.cartBar.limitedByTariff(nPrice);
            });
        },
        addToCart:function(){
            $("#addCart").click(function(event){
                if($(this).hasClass('disabled')){
                    return false;
                }
                var addcar = $(this);
                var offset = $(".shopcart").offset();
                var img = $('#showImg').attr('src');
                var flyer = $('<img class="u-flyer" src="'+img+'">');
                flyer.fly({
                    start: {
                        left: $(this).offset().left,//event.pageX,
                        top: $(this).offset().top //event.pageY
                    },
                    end: {
                        left: offset.left+10,
                        top: offset.top+10,
                        width: 0,
                        height: 0
                    },
                    onEnd: function(){
                        var param={
                            item_id:$('#item_id').val(),
                            item_num:$('#goodsAmount').val()
                        }
                        $.get('/order/cart.html',param,function(r){
                            r=JSON.parse(r);
                            if(r.state==200){
                                var productscount=parseInt($('#rightBar2 .num').text(),10)+parseInt($('#goodsAmount').val(),10);
                                productscount=productscount>99?'99+':productscount;
                                $('#rightBar2 .num,#newcartnum').text(productscount);
                            }

                        });

                        this.destory();
                    }
                });
            });
        }
    },
    similar:{
        init:function(){
            this.get();
        },
        get:function(){
            var param={
                category_id:$('#category_id').val()
            }

            $('#pro_seeAga,#pro_actBuy').empty();
            $.getJSON('/item/similar.html',param,function(r){
                $('#templateSeeGoodsList').tmpl(r.viewitems).appendTo('#pro_seeAga');
                $('#pro_seeAga li:last').addClass('bbNone');
                $('#templateSeeGoodsList').tmpl(r.buyitems).appendTo('#pro_actBuy');
                $('#pro_actBuy li:last').addClass('bbNone');
            });
        }
    },
    hisGoods:{
        init:function(){
            ht.util.lazyGet($('#pro_recBow'),function(){
                ht.product.hisGoods.get();
            });
        },

        get:function(){
            $('#pro_recBow').empty();
            $.getJSON('/item/history.html',function(r){
                $('#templateHisGoodsList').tmpl(r).appendTo('#pro_recBow');
            });
        }
    }

};$(function(){
    ht.product.init();
});
